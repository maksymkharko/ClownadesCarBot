<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мои авто</title>
    <meta name="theme-color" content="#2481cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --background-color: var(--tg-theme-bg-color, #f5f5f5);
            --glass-background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.9));
            --text-primary: var(--tg-theme-text-color, #333);
            --text-secondary: var(--tg-theme-hint-color, #666);
            --accent-color: var(--tg-theme-button-color, #2481cc);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --accent-red: #ff3b30;
            --accent-green: #34c759;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --animation-duration: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 8px 0;
        }

        .main-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
            color: var(--text-primary);
        }

        .add-car-button {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: transform var(--animation-duration) ease, opacity var(--animation-duration) ease;
        }

        .add-car-button:active {
            transform: scale(0.95);
            opacity: 0.9;
        }

        .car-list {
            display: grid;
            gap: 16px;
        }

        .car-item {
            background: var(--glass-background);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow);
            cursor: pointer;
            position: relative;
            transform: translateX(0);
            transition: transform var(--animation-duration) ease, box-shadow var(--animation-duration) ease;
        }

        .car-item:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .car-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .timer-container {
            display: grid;
            gap: 8px;
        }

        .timer {
            background: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color var(--animation-duration) ease;
        }

        .timer.warning {
            background: rgba(255, 59, 48, 0.1);
            color: var(--accent-red);
        }

        .timer-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .timer-value {
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            opacity: 0;
            transition: opacity var(--animation-duration) ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: white;
            margin: 16px;
            padding: 24px;
            border-radius: var(--border-radius);
            max-width: 600px;
            margin: 16px auto;
            transform: translateY(20px);
            transition: transform var(--animation-duration) ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color var(--animation-duration) ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 24px;
        }

        .modal-buttons button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform var(--animation-duration) ease, opacity var(--animation-duration) ease;
        }

        .modal-buttons button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .save-button {
            background: var(--accent-color);
            color: white;
        }

        .cancel-button {
            background: #f5f5f5;
            color: var(--text-primary);
        }

        .delete-button {
            background: var(--accent-red);
            color: white;
        }

        .car-info {
            margin-top: 16px;
        }

        .info-grid {
            display: grid;
            gap: 16px;
        }

        .info-item {
            display: grid;
            gap: 4px;
        }

        .info-item label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .vin-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-button {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            padding: 4px;
            transition: opacity var(--animation-duration) ease;
        }

        .copy-button:active {
            opacity: 0.7;
        }

        .description-text {
            white-space: pre-wrap;
            margin: 8px 0;
            padding: 12px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        .edit-description-button {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            padding: 8px 0;
            text-align: left;
            transition: opacity var(--animation-duration) ease;
        }

        .edit-description-button:active {
            opacity: 0.7;
        }

        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--animation-duration) ease;
        }

        .confirmation-dialog.show {
            opacity: 1;
        }

        .dialog-content {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform var(--animation-duration) ease;
        }

        .confirmation-dialog.show .dialog-content {
            transform: scale(1);
        }

        .dialog-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 24px;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            opacity: 0;
            transition: transform var(--animation-duration) ease, opacity var(--animation-duration) ease;
            z-index: 1200;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .delete-action {
            position: absolute;
            right: -80px;
            top: 0;
            bottom: 0;
            width: 80px;
            background: var(--accent-red);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            opacity: 0;
            transition: opacity var(--animation-duration) ease;
        }

        .car-item.swiping .delete-action {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 48px 16px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--accent-color);
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 24px;
        }

        .empty-state button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform var(--animation-duration) ease, opacity var(--animation-duration) ease;
        }

        .empty-state button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .footer {
            margin-top: auto;
            text-align: center;
            padding: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .footer a {
            color: var(--accent-color);
            text-decoration: none;
        }

        /* Dark theme specific adjustments */
        @media (prefers-color-scheme: dark) {
            :root {
                --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }

            .timer {
                background: rgba(255, 255, 255, 0.1);
            }

            .description-text {
                background: rgba(255, 255, 255, 0.1);
            }

            input, textarea {
                background: var(--glass-background);
                color: var(--text-primary);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .cancel-button {
                background: var(--glass-background);
            }
        }

        @media (max-width: 600px) {
            .app-container {
                padding: 12px;
            }

            .modal-content {
                margin: 12px;
                padding: 16px;
            }

            .car-name {
                font-size: 16px;
            }

            .timer-label {
                font-size: 12px;
            }

            .modal-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="top-panel">
            <div class="control-buttons">
                <button class="add-car-button">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <h1 class="main-title">Мои авто</h1>

        <div class="car-list" id="carList">
            <!-- Cars will be added here dynamically -->
        </div>

        <div class="footer">
            <a href="https://t.me/clownades" target="_blank">@clownades</a>
        </div>
    </div>

    <!-- Add Car Modal -->
    <div class="modal" id="addCarModal">
        <div class="modal-content">
            <h2>Добавить автомобиль</h2>
            <form id="addCarForm">
                <div class="form-group">
                    <label for="carName">Название машины*</label>
                    <input type="text" id="carName" required placeholder="Например: Toyota Camry">
                </div>
                <div class="form-group">
                    <label for="mileage">Актуальный пробег (км)*</label>
                    <input type="number" id="mileage" required placeholder="Например: 50000">
                </div>
                <div class="form-group">
                    <label for="vin">VIN*</label>
                    <input type="text" id="vin" required placeholder="17-значный номер">
                </div>
                <div class="form-group">
                    <label for="plate">Номер машины*</label>
                    <input type="text" id="plate" required placeholder="Например: А123БВ777">
                </div>
                <div class="form-group">
                    <label for="purchaseDate">Дата покупки*</label>
                    <input type="date" id="purchaseDate" required>
                </div>
                <div class="form-group">
                    <label for="lastOilChange">Пробег на последней замене масла (км)*</label>
                    <input type="number" id="lastOilChange" required placeholder="Например: 45000">
                </div>
                <div class="form-group">
                    <label for="lastTimingBelt">Пробег на последней замене ГРМ (км)*</label>
                    <input type="number" id="lastTimingBelt" required placeholder="Например: 40000">
                </div>
                <div class="form-group">
                    <label for="insuranceEnd">Дата окончания страховки*</label>
                    <input type="date" id="insuranceEnd" required>
                </div>
                <div class="form-group">
                    <label for="maintenanceEnd">Дата окончания ТО*</label>
                    <input type="date" id="maintenanceEnd" required>
                </div>
                <div class="form-group">
                    <label for="description">Описание</label>
                    <textarea id="description" rows="4" placeholder="Добавьте любую дополнительную информацию"></textarea>
                </div>
                <div class="form-group">
                    <label for="link1">Ссылка 1</label>
                    <input type="url" id="link1" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label for="link2">Ссылка 2</label>
                    <input type="url" id="link2" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label for="link3">Ссылка 3</label>
                    <input type="url" id="link3" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label for="link4">Ссылка 4</label>
                    <input type="url" id="link4" placeholder="https://...">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="save-button">Сохранить</button>
                    <button type="button" class="cancel-button">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View/Edit Car Modal -->
    <div class="modal" id="viewCarModal">
        <div class="modal-content">
            <h2>Информация об автомобиле</h2>
            <div class="car-info">
                <!-- Car info will be populated dynamically -->
            </div>
            <div class="modal-buttons">
                <button class="edit-button">Редактировать</button>
                <button class="delete-button">Удалить</button>
                <button class="close-button">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="dialog-content">
            <p>Вы уверены, что хотите удалить этот автомобиль?</p>
            <div class="dialog-buttons">
                <button class="confirm-button">Удалить</button>
                <button class="cancel-button">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Constants
        const OIL_CHANGE_INTERVAL = 10000; // 10,000 km
        const WARNING_DAYS = 7;

        // DOM Elements
        const carList = document.getElementById('carList');
        const addCarModal = document.getElementById('addCarModal');
        const viewCarModal = document.getElementById('viewCarModal');
        const confirmationDialog = document.getElementById('confirmationDialog');
        const toast = document.getElementById('toast');
        const addCarForm = document.getElementById('addCarForm');

        // State
        let cars = [];
        let currentCarIndex = -1;

        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        
        // Apply Telegram theme
        function applyTheme() {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color);
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color);
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                tg.expand();
                tg.enableClosingConfirmation();
                applyTheme();
                
                // Listen for theme changes
                tg.onEvent('themeChanged', applyTheme);
                
                await loadCars();
                setupEventListeners();
                setupTouchHandlers();
                setupKeyboardHandling();
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Ошибка инициализации приложения');
            }
        });

        // Touch handling variables
        let touchStartX = 0;
        let touchEndX = 0;
        let currentSwipeItem = null;
        const SWIPE_THRESHOLD = 50;

        // Touch Handlers Setup
        function setupTouchHandlers() {
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMove, { passive: true });
            document.addEventListener('touchend', handleTouchEnd, { passive: true });
        }

        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
            const carItem = e.target.closest('.car-item');
            if (carItem) {
                currentSwipeItem = carItem;
                carItem.classList.add('swiping');
            }
        }

        function handleTouchMove(e) {
            if (!currentSwipeItem) return;
            
            touchEndX = e.touches[0].clientX;
            const diff = touchStartX - touchEndX;
            
            if (diff > 0) { // Swiping left
                const translateX = Math.max(-80, -diff);
                currentSwipeItem.style.transform = `translateX(${translateX}px)`;
            }
        }

        function handleTouchEnd(e) {
            if (!currentSwipeItem) return;

            const diff = touchStartX - touchEndX;
            if (diff > SWIPE_THRESHOLD) {
                // Trigger haptic feedback
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
                
                // Show delete confirmation
                const index = Array.from(carList.children).indexOf(currentSwipeItem);
                currentCarIndex = index;
                showDeleteConfirmation();
            }

            // Reset swipe
            currentSwipeItem.style.transform = '';
            currentSwipeItem.classList.remove('swiping');
            currentSwipeItem = null;
        }

        // Keyboard Handling
        function setupKeyboardHandling() {
            document.addEventListener('click', (e) => {
                if (!e.target.matches('input, textarea')) {
                    document.activeElement.blur();
                }
            });
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Add car button with haptic feedback
            document.querySelector('.add-car-button').addEventListener('click', () => {
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
                showModal(addCarModal);
            });

            // Add car form
            addCarForm.addEventListener('submit', handleAddCar);
            addCarModal.querySelector('.cancel-button').addEventListener('click', () => {
                hideModal(addCarModal);
                addCarForm.reset();
            });

            // View car modal buttons
            viewCarModal.querySelector('.edit-button').addEventListener('click', handleEditCar);
            viewCarModal.querySelector('.delete-button').addEventListener('click', showDeleteConfirmation);
            viewCarModal.querySelector('.close-button').addEventListener('click', () => {
                hideModal(viewCarModal);
            });

            // Confirmation dialog
            confirmationDialog.querySelector('.confirm-button').addEventListener('click', handleDeleteCar);
            confirmationDialog.querySelector('.cancel-button').addEventListener('click', () => {
                hideModal(confirmationDialog);
            });

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === addCarModal) hideModal(addCarModal);
                if (e.target === viewCarModal) hideModal(viewCarModal);
            });

            // Add haptic feedback to all buttons
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => {
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                });
            });
        }

        // Modal handling
        function showModal(modal) {
            modal.style.display = 'block';
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
        }

        function hideModal(modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Car Management Functions
        async function loadCars() {
            try {
                const data = await tg.CloudStorage.getItem('cars');
                cars = data ? JSON.parse(data) : [];
                renderCarList();
            } catch (e) {
                console.error('Error loading cars:', e);
                cars = [];
                showToast('Ошибка загрузки данных');
            }
        }

        async function saveCars() {
            try {
                await tg.CloudStorage.setItem('cars', JSON.stringify(cars));
            } catch (e) {
                console.error('Error saving cars:', e);
                showToast('Ошибка сохранения данных');
                throw e; // Re-throw to handle in the calling function
            }
        }

        async function handleAddCar(e) {
            e.preventDefault();
            
            try {
                const newCar = {
                    name: document.getElementById('carName').value,
                    mileage: parseInt(document.getElementById('mileage').value),
                    vin: document.getElementById('vin').value.toUpperCase(),
                    plate: document.getElementById('plate').value.toUpperCase(),
                    purchaseDate: document.getElementById('purchaseDate').value,
                    lastOilChangeMileage: parseInt(document.getElementById('lastOilChange').value),
                    lastTimingBeltMileage: parseInt(document.getElementById('lastTimingBelt').value),
                    insuranceEndDate: document.getElementById('insuranceEnd').value,
                    maintenanceEndDate: document.getElementById('maintenanceEnd').value,
                    description: document.getElementById('description').value || '',
                    link1: formatURL(document.getElementById('link1').value),
                    link2: formatURL(document.getElementById('link2').value),
                    link3: formatURL(document.getElementById('link3').value),
                    link4: formatURL(document.getElementById('link4').value)
                };

                cars.push(newCar);
                await saveCars();
                renderCarList();
                
                hideModal(addCarModal);
                addCarForm.reset();
                showToast('Автомобиль добавлен');
            } catch (error) {
                console.error('Error adding car:', error);
                showToast('Ошибка при добавлении автомобиля');
            }
        }

        async function handleEditCar() {
            const carInfo = viewCarModal.querySelector('.car-info');
            const car = cars[currentCarIndex];

            if (carInfo.classList.contains('editing')) {
                // Save changes
                car.name = carInfo.querySelector('[data-field="name"]').value;
                car.mileage = parseInt(carInfo.querySelector('[data-field="mileage"]').value);
                car.vin = carInfo.querySelector('[data-field="vin"]').value.toUpperCase();
                car.plate = carInfo.querySelector('[data-field="plate"]').value.toUpperCase();
                car.purchaseDate = carInfo.querySelector('[data-field="purchaseDate"]').value;
                car.lastOilChangeMileage = parseInt(carInfo.querySelector('[data-field="lastOilChangeMileage"]').value);
                car.lastTimingBeltMileage = parseInt(carInfo.querySelector('[data-field="lastTimingBeltMileage"]').value);
                car.insuranceEndDate = carInfo.querySelector('[data-field="insuranceEndDate"]').value;
                car.maintenanceEndDate = carInfo.querySelector('[data-field="maintenanceEndDate"]').value;
                car.description = carInfo.querySelector('[data-field="description"]').value;
                car.link1 = formatURL(carInfo.querySelector('[data-field="link1"]').value);
                car.link2 = formatURL(carInfo.querySelector('[data-field="link2"]').value);
                car.link3 = formatURL(carInfo.querySelector('[data-field="link3"]').value);
                car.link4 = formatURL(carInfo.querySelector('[data-field="link4"]').value);

                await saveCars();
                renderCarList();
                showToast('Изменения сохранены');
                
                carInfo.classList.remove('editing');
                viewCarModal.querySelector('.edit-button').textContent = 'Редактировать';
                renderCarInfo(car);
            } else {
                // Enter edit mode
                carInfo.classList.add('editing');
                viewCarModal.querySelector('.edit-button').textContent = 'Сохранить';
                renderCarInfoEditable(car);
            }
        }

        async function handleDeleteCar() {
            cars.splice(currentCarIndex, 1);
            await saveCars();
            renderCarList();
            
            hideModal(confirmationDialog);
            hideModal(viewCarModal);
            showToast('Автомобиль удален');
        }

        // UI Functions
        function renderCarList() {
            carList.innerHTML = '';
            
            if (cars.length === 0) {
                carList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-car"></i>
                        <p>У вас пока нет добавленных автомобилей</p>
                        <button onclick="document.querySelector('.add-car-button').click()">
                            Добавить автомобиль
                        </button>
                    </div>
                `;
                return;
            }

            cars.forEach((car, index) => {
                const carElement = createCarElement(car, index);
                carList.appendChild(carElement);
            });
        }

        function createCarElement(car, index) {
            const div = document.createElement('div');
            div.className = 'car-item';
            div.innerHTML = `
                <div class="car-name">${car.name}</div>
                <div class="timer-container">
                    <div class="timer ${isDateWarning(car.insuranceEndDate) ? 'warning' : ''}">
                        <div class="timer-label">Страховка</div>
                        <div class="timer-value">${formatTimeRemaining(car.insuranceEndDate)}</div>
                    </div>
                    <div class="timer ${isDateWarning(car.maintenanceEndDate) ? 'warning' : ''}">
                        <div class="timer-label">ТО</div>
                        <div class="timer-value">${formatTimeRemaining(car.maintenanceEndDate)}</div>
                    </div>
                    <div class="timer">
                        <div class="timer-label">До замены масла</div>
                        <div class="timer-value">${formatMileageRemaining(car.mileage, car.lastOilChangeMileage)} км</div>
                    </div>
                </div>
                <div class="delete-action">
                    <i class="fas fa-trash"></i>
                </div>
            `;

            div.addEventListener('click', () => {
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
                showCarDetails(index);
            });
            return div;
        }

        function renderCarInfo(car) {
            const carInfo = viewCarModal.querySelector('.car-info');
            carInfo.innerHTML = `
                <h3>${car.name}</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>VIN:</label>
                        <div class="vin-container">
                            <span>${car.vin}</span>
                            <button class="copy-button" onclick="copyVIN('${car.vin}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="info-item">
                        <label>Номер:</label>
                        <span>${car.plate}</span>
                    </div>
                    <div class="info-item">
                        <label>Пробег:</label>
                        <span>${car.mileage} км</span>
                    </div>
                    <div class="info-item">
                        <label>Дата покупки:</label>
                        <span>${formatDate(car.purchaseDate)}</span>
                    </div>
                    <div class="info-item">
                        <label>Последняя замена масла:</label>
                        <span>${car.lastOilChangeMileage} км</span>
                    </div>
                    <div class="info-item">
                        <label>Последняя замена ГРМ:</label>
                        <span>${car.lastTimingBeltMileage} км</span>
                    </div>
                    <div class="info-item">
                        <label>Страховка до:</label>
                        <span>${formatDate(car.insuranceEndDate)}</span>
                    </div>
                    <div class="info-item">
                        <label>ТО до:</label>
                        <span>${formatDate(car.maintenanceEndDate)}</span>
                    </div>
                    <div class="info-item full-width">
                        <label>Описание:</label>
                        <div class="description-text">${car.description || 'Нет описания'}</div>
                        <button class="edit-description-button" onclick="editDescription(${currentCarIndex})">
                            <i class="fas fa-edit"></i> Редактировать описание
                        </button>
                    </div>
                    ${renderLinks(car)}
                </div>
            `;
        }

        function renderCarInfoEditable(car) {
            const carInfo = viewCarModal.querySelector('.car-info');
            carInfo.innerHTML = `
                <div class="form-group">
                    <label>Название:</label>
                    <input type="text" data-field="name" value="${car.name}" required>
                </div>
                <div class="form-group">
                    <label>VIN:</label>
                    <input type="text" data-field="vin" value="${car.vin}" required>
                </div>
                <div class="form-group">
                    <label>Номер:</label>
                    <input type="text" data-field="plate" value="${car.plate}" required>
                </div>
                <div class="form-group">
                    <label>Пробег:</label>
                    <input type="number" data-field="mileage" value="${car.mileage}" required>
                </div>
                <div class="form-group">
                    <label>Дата покупки:</label>
                    <input type="date" data-field="purchaseDate" value="${car.purchaseDate}" required>
                </div>
                <div class="form-group">
                    <label>Последняя замена масла:</label>
                    <input type="number" data-field="lastOilChangeMileage" value="${car.lastOilChangeMileage}" required>
                </div>
                <div class="form-group">
                    <label>Последняя замена ГРМ:</label>
                    <input type="number" data-field="lastTimingBeltMileage" value="${car.lastTimingBeltMileage}" required>
                </div>
                <div class="form-group">
                    <label>Страховка до:</label>
                    <input type="date" data-field="insuranceEndDate" value="${car.insuranceEndDate}" required>
                </div>
                <div class="form-group">
                    <label>ТО до:</label>
                    <input type="date" data-field="maintenanceEndDate" value="${car.maintenanceEndDate}" required>
                </div>
                <div class="form-group">
                    <label>Описание:</label>
                    <textarea data-field="description" rows="4">${car.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Ссылка 1:</label>
                    <input type="url" data-field="link1" value="${car.link1 || ''}">
                </div>
                <div class="form-group">
                    <label>Ссылка 2:</label>
                    <input type="url" data-field="link2" value="${car.link2 || ''}">
                </div>
                <div class="form-group">
                    <label>Ссылка 3:</label>
                    <input type="url" data-field="link3" value="${car.link3 || ''}">
                </div>
                <div class="form-group">
                    <label>Ссылка 4:</label>
                    <input type="url" data-field="link4" value="${car.link4 || ''}">
                </div>
            `;
        }

        function renderLinks(car) {
            let linksHtml = '';
            for (let i = 1; i <= 4; i++) {
                const link = car[`link${i}`];
                if (link) {
                    linksHtml += `
                        <div class="info-item">
                            <label>Ссылка ${i}:</label>
                            <a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a>
                        </div>
                    `;
                }
            }
            return linksHtml;
        }

        function showCarDetails(index) {
            currentCarIndex = index;
            const car = cars[index];
            renderCarInfo(car);
            showModal(viewCarModal);
        }

        function showDeleteConfirmation() {
            showModal(confirmationDialog);
        }

        function copyVIN(vin) {
            navigator.clipboard.writeText(vin).then(() => {
                showToast('VIN скопирован');
            }).catch(err => {
                console.error('Failed to copy VIN:', err);
                showToast('Ошибка копирования VIN');
            });
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ru-RU');
        }

        function formatTimeRemaining(dateString) {
            const endDate = new Date(dateString);
            const now = new Date();
            const diffTime = endDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? `${diffDays} дн` : 'Истекло';
        }

        function formatMileageRemaining(currentMileage, lastChangeMileage) {
            const remaining = OIL_CHANGE_INTERVAL - (currentMileage - lastChangeMileage);
            return remaining > 0 ? remaining : 0;
        }

        function isDateWarning(dateString) {
            const endDate = new Date(dateString);
            const now = new Date();
            const diffTime = endDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= WARNING_DAYS && diffDays > 0;
        }

        async function editDescription(index) {
            const car = cars[index];
            const descriptionText = document.querySelector('.description-text');
            const editButton = document.querySelector('.edit-description-button');
            
            if (descriptionText) {
                const textarea = document.createElement('textarea');
                textarea.className = 'description-edit';
                textarea.value = car.description || '';
                descriptionText.replaceWith(textarea);
                textarea.focus();
                
                editButton.textContent = 'Сохранить';
                editButton.onclick = async () => {
                    car.description = textarea.value;
                    await saveCars();
                    renderCarInfo(car);
                    showToast('Описание обновлено');
                };
            }
        }

        function formatURL(url) {
            if (!url) return '';
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                return 'https://' + url;
            }
            return url;
        }
    </script>
</body>
</html> 
