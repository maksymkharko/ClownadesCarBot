<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои Авто</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* Variables for Telegram theme adaptation */
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --link-color: var(--tg-theme-link-color, #2481cc);
            --button-color: var(--tg-theme-button-color, #2481cc);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --card-bg-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --border-color: rgba(0, 0, 0, 0.1);
            --red-color: var(--tg-theme-destructive-text-color, #ff3b30);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .screen {
            display: none; /* Hidden by default */
            flex-grow: 1;
            flex-direction: column;
        }

        .screen.active {
            display: flex; /* Shown when active */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--card-bg-color);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            flex-grow: 1;
            text-align: center;
        }

        .header .left-btn, .header .right-btn {
            width: 60px; /* To allow h1 to be centered */
            text-align: center;
        }
        .header .left-btn button, .header .right-btn button {
            background: none;
            border: none;
            color: var(--link-color);
            cursor: pointer;
            padding: 0;
            font-size: 16px;
        }
        .header .right-btn button.add-button {
            font-size: 30px;
            line-height: 1;
        }

        .car-list-content {
            flex-grow: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .car-card {
            background-color: var(--card-bg-color);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease-out; /* For click effect */
        }

        .car-card:active {
            transform: translateY(2px); /* Slight press effect */
        }

        .car-card-content {
            flex-grow: 1;
            padding-right: 80px; /* Space for delete button */
        }

        .car-card h2 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color);
        }

        .car-card .mileage {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .car-card .indicators p {
            margin: 3px 0;
            font-size: 14px;
            color: var(--hint-color);
        }

        .car-card .indicator-danger {
            color: var(--red-color);
            font-weight: 500;
        }

        /* Styles for swipe to delete */
        .delete-button-wrapper {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 70px;
            background-color: var(--red-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .car-card.swiped .delete-button-wrapper {
            transform: translateX(0);
        }

        .delete-button {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
        }

        /* Car Details Form */
        .car-details-form {
            flex-grow: 1;
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            overflow-y: auto; /* Enable scrolling for content */
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-section h3 {
            font-size: 16px;
            color: var(--hint-color);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--hint-color);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--link-color);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .input-with-button {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-with-button input {
            flex-grow: 1;
        }

        .copy-button, .update-button {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .copy-button:active, .update-button:active {
            opacity: 0.8;
        }

        .link-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .link-slot input[type="text"] {
            flex-grow: 1;
        }

        .link-slot .link-label {
            width: 80px;
            font-size: 14px;
            color: var(--hint-color);
            white-space: nowrap;
        }

        .footer {
            padding: 15px;
            text-align: center;
            font-size: 12px;
            color: var(--hint-color);
            background-color: var(--card-bg-color);
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .footer a {
            color: var(--link-color);
            text-decoration: none;
        }
    </style>
</head>
<body>

    <div id="mainScreen" class="screen active">
        <div class="header">
            <div class="left-btn"></div>
            <h1>Мои Авто</h1>
            <div class="right-btn">
                <button class="add-button" id="addCarButton">+</button>
            </div>
        </div>

        <div class="car-list-content" id="carList">
            </div>

        <div class="footer">
            Разработано <a href="https://t.me/clownades" target="_blank">@clownades</a>
        </div>
    </div>

    <div id="carDetailsScreen" class="screen">
        <div class="header">
            <div class="left-btn">
                <button class="back-button" id="backButton">Назад</button>
            </div>
            <h1 id="carDetailsHeader">Новый Авто</h1>
            <div class="right-btn"></div>
        </div>

        <form class="car-details-form" id="carDetailsForm">
            <input type="hidden" id="currentCarId" value="">

            <div class="form-section">
                <h3>Основное</h3>
                <div class="form-group">
                    <label for="carName">Название авто:</label>
                    <input type="text" id="carName" name="name" placeholder="Введите название" required>
                </div>
                <div class="form-group">
                    <label for="vin">VIN:</label>
                    <div class="input-with-button">
                        <input type="text" id="vin" name="vin" placeholder="Введите VIN">
                        <button type="button" class="copy-button" id="copyVin">Копировать</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="plateNumber">Госномер:</label>
                    <div class="input-with-button">
                        <input type="text" id="plateNumber" name="plateNumber" placeholder="Введите госномер">
                        <button type="button" class="copy-button" id="copyPlateNumber">Копировать</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="purchaseDate">Дата покупки:</label>
                    <input type="date" id="purchaseDate" name="purchaseDate">
                </div>
            </div>

            <div class="form-section">
                <h3>Пробеги</h3>
                <div class="form-group">
                    <label for="currentMileage">Текущий пробег (км):</label>
                    <div class="input-with-button">
                        <input type="number" id="currentMileage" name="currentMileage" placeholder="Введите текущий пробег">
                        <button type="button" class="update-button" id="updateMileage">Обновить</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="lastOilChangeMileage">Последняя замена масла (км):</label>
                    <input type="number" id="lastOilChangeMileage" name="lastOilChangeMileage" placeholder="Пробег при последней замене">
                </div>
                <div class="form-group">
                    <label for="lastTimingBeltMileage">Последняя замена ГРМ (км):</label>
                    <input type="number" id="lastTimingBeltMileage" name="lastTimingBeltMileage" placeholder="Пробег при последней замене">
                </div>
            </div>

            <div class="form-section">
                <h3>Даты</h3>
                <div class="form-group">
                    <label for="insuranceEndDate">Окончание страховки:</label>
                    <input type="date" id="insuranceEndDate" name="insuranceEndDate">
                </div>
                <div class="form-group">
                    <label for="toEndDate">Окончание ТО:</label>
                    <input type="date" id="toEndDate" name="toEndDate">
                </div>
            </div>

            <div class="form-section">
                <h3>Дополнительно</h3>
                <div class="form-group">
                    <label for="notes">Заметка:</label>
                    <textarea id="notes" name="notes" placeholder="Ваши заметки"></textarea>
                </div>
                <div class="form-group">
                    <label>Ссылки:</label>
                    <div class="link-slot">
                        <span class="link-label">Ссылка 1:</span>
                        <input type="text" name="link1" placeholder="Название или URL">
                    </div>
                    <div class="link-slot">
                        <span class="link-label">Ссылка 2:</span>
                        <input type="text" name="link2" placeholder="Название или URL">
                    </div>
                    <div class="link-slot">
                        <span class="link-label">Ссылка 3:</span>
                        <input type="text" name="link3" placeholder="Название или URL">
                    </div>
                    <div class="link-slot">
                        <span class="link-label">Ссылка 4:</span>
                        <input type="text" name="link4" placeholder="Название или URL">
                    </div>
                </div>
            </div>
        </form>

        <div class="footer">
            Разработано <a href="https://t.me/clownades" target="_blank">@clownades</a>
        </div>
    </div>

    <script>
        // --- Telegram Web App Initialization & Theme Adaptation ---
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        function applyTelegramTheme() {
            const body = document.body;
            const themeParams = Telegram.WebApp.themeParams;
            if (themeParams) {
                body.style.setProperty('--tg-theme-bg-color', themeParams.bg_color || '#ffffff');
                body.style.setProperty('--tg-theme-text-color', themeParams.text_color || '#000000');
                body.style.setProperty('--tg-theme-hint-color', themeParams.hint_color || '#999999');
                body.style.setProperty('--tg-theme-link-color', themeParams.link_color || '#2481cc');
                body.style.setProperty('--tg-theme-button-color', themeParams.button_color || '#2481cc');
                body.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color || '#ffffff');
                body.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color || '#f0f0f0');
                body.style.setProperty('--tg-theme-destructive-text-color', themeParams.destructive_text_color || '#ff3b30');
            }
        }

        applyTelegramTheme();
        Telegram.WebApp.onEvent('themeChanged', applyTelegramTheme);

        // --- View Management ---
        const mainScreen = document.getElementById('mainScreen');
        const carDetailsScreen = document.getElementById('carDetailsScreen');
        const carListContainer = document.getElementById('carList');
        const carDetailsForm = document.getElementById('carDetailsForm');
        const currentCarIdInput = document.getElementById('currentCarId');
        const carNameInput = document.getElementById('carName');
        const carDetailsHeader = document.getElementById('carDetailsHeader');

        let cars = []; // Array to hold car data

        function showScreen(screenId) {
            mainScreen.classList.remove('active');
            carDetailsScreen.classList.remove('active');
            document.getElementById(screenId).classList.add('active');
            Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }

        // --- Data Storage (using localStorage for demonstration) ---
        // In a real Telegram Mini App, replace these with Telegram.WebApp.cloudStorage
        // e.g., await Telegram.WebApp.cloudStorage.setItem(key, JSON.stringify(value));
        // and await Telegram.WebApp.cloudStorage.getItem(key);

        const STORAGE_KEY = 'telegram_mini_app_cars';
        const MAX_CARS = 10;

        async function loadCars() {
            try {
                // In production: const rawData = await Telegram.WebApp.cloudStorage.getItem(STORAGE_KEY + '_' + Telegram.WebApp.initDataUnsafe.user.id);
                const rawData = localStorage.getItem(STORAGE_KEY); // For local testing
                cars = rawData ? JSON.parse(rawData) : [];
                renderCarList();
                checkAlerts();
            } catch (e) {
                console.error("Failed to load cars:", e);
                Telegram.WebApp.showAlert('Ошибка загрузки данных!');
            }
        }

        async function saveCars() {
            try {
                // In production: await Telegram.WebApp.cloudStorage.setItem(STORAGE_KEY + '_' + Telegram.WebApp.initDataUnsafe.user.id, JSON.stringify(cars));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(cars)); // For local testing
                console.log('Cars saved:', cars);
                renderCarList(); // Re-render list after saving
            } catch (e) {
                console.error("Failed to save cars:", e);
                Telegram.WebApp.showAlert('Ошибка сохранения данных!');
            }
        }

        // --- Helper Functions ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}.${month}.${year}`;
        }

        function parseDate(dateString) {
             // Converts DD.MM.YYYY to YYYY-MM-DD for date input
            if (!dateString) return '';
            const [day, month, year] = dateString.split('.');
            return `${year}-${month}-${day}`;
        }

        function calculateDaysUntil(eventDateStr) {
            if (!eventDateStr) return null;
            const eventDate = new Date(eventDateStr); // Expects YYYY-MM-DD
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time for accurate day difference

            const diffTime = eventDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function calculateOilChange(currentMileage, lastOilChangeMileage) {
            if (currentMileage === null || lastOilChangeMileage === null) return null;
            const diff = currentMileage - lastOilChangeMileage;
            return 10000 - diff;
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // --- Car List Screen Logic ---
        function renderCarList() {
            carListContainer.innerHTML = ''; // Clear existing cards
            if (cars.length === 0) {
                carListContainer.innerHTML = '<p style="text-align: center; color: var(--hint-color);">Добавьте свой первый автомобиль!</p>';
                return;
            }

            cars.forEach(car => {
                const card = document.createElement('div');
                card.classList.add('car-card');
                card.dataset.carId = car.id;

                const oilRemaining = calculateOilChange(car.currentMileage, car.lastOilChangeMileage);
                const insuranceDays = calculateDaysUntil(car.insuranceEndDate);
                const toDays = calculateDaysUntil(car.toEndDate);

                card.innerHTML = `
                    <div class="car-card-content">
                        <h2>${car.name || 'Без названия'}</h2>
                        <p class="mileage">${car.currentMileage ? car.currentMileage + ' км' : 'Нет данных'}</p>
                        <div class="indicators">
                            <p>Масло: <span class="indicator-value ${oilRemaining !== null && oilRemaining <= 1000 ? 'indicator-danger' : ''}">
                                ${oilRemaining !== null ? oilRemaining + ' км' : 'Нет данных'}
                            </span></p>
                            <p>Страховка: <span class="indicator-value ${insuranceDays !== null && insuranceDays <= 30 ? 'indicator-danger' : ''}">
                                ${insuranceDays !== null ? insuranceDays + ' дн.' : 'Нет данных'}
                            </span></p>
                            <p>ТО: <span class="indicator-value ${toDays !== null && toDays <= 30 ? 'indicator-danger' : ''}">
                                ${toDays !== null ? toDays + ' дн.' : 'Нет данных'}
                            </span></p>
                        </div>
                    </div>
                    <div class="delete-button-wrapper">
                        <button class="delete-button">Удалить</button>
                    </div>
                `;

                // Handle click to edit
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-button')) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('light');
                        editCar(car.id);
                    }
                });

                // Handle swipe to delete (simplified to toggle class on click for demo)
                let touchStartX = 0;
                card.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                });
                card.addEventListener('touchend', (e) => {
                    const touchEndX = e.changedTouches[0].clientX;
                    if (touchStartX - touchEndX > 50) { // Swiped left
                        card.classList.add('swiped');
                        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                    } else if (touchEndX - touchStartX > 50) { // Swiped right
                        card.classList.remove('swiped');
                    } else if (!e.target.closest('.delete-button')) {
                        // If not a swipe and not on delete button, close any open swipe
                        document.querySelectorAll('.car-card.swiped').forEach(c => c.classList.remove('swiped'));
                    }
                });

                // Handle delete button click
                card.querySelector('.delete-button').addEventListener('click', () => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                    Telegram.WebApp.showConfirm('Вы уверены, что хотите удалить этот автомобиль?', (confirmed) => {
                        if (confirmed) {
                            deleteCar(car.id);
                        } else {
                            card.classList.remove('swiped'); // Hide delete button if not confirmed
                        }
                    });
                });

                carListContainer.appendChild(card);
            });
        }

        function deleteCar(id) {
            cars = cars.filter(car => car.id !== id);
            saveCars();
        }

        function checkAlerts() {
            let alerts = [];
            cars.forEach(car => {
                const insuranceDays = calculateDaysUntil(car.insuranceEndDate);
                const toDays = calculateDaysUntil(car.toEndDate);

                if (insuranceDays !== null && insuranceDays <= 30 && insuranceDays >= 0) {
                    alerts.push(`Приближается срок страховки для "${car.name || 'Авто без названия'}" (${insuranceDays} дн.)`);
                }
                if (toDays !== null && toDays <= 30 && toDays >= 0) {
                    alerts.push(`Приближается срок ТО для "${car.name || 'Авто без названия'}" (${toDays} дн.)`);
                }
            });

            if (alerts.length > 0) {
                Telegram.WebApp.showAlert(alerts.join('\n\n'));
            }
        }


        // --- Car Details Screen Logic ---
        function resetCarDetailsForm() {
            carDetailsForm.reset();
            currentCarIdInput.value = '';
            carNameInput.value = '';
            carDetailsHeader.textContent = 'Новый Авто';
        }

        function fillCarDetailsForm(car) {
            currentCarIdInput.value = car.id;
            carNameInput.value = car.name || '';
            carDetailsHeader.textContent = car.name || 'Новый Авто';

            document.getElementById('vin').value = car.vin || '';
            document.getElementById('plateNumber').value = car.plateNumber || '';
            document.getElementById('purchaseDate').value = car.purchaseDate || ''; // YYYY-MM-DD

            document.getElementById('currentMileage').value = car.currentMileage || '';
            document.getElementById('lastOilChangeMileage').value = car.lastOilChangeMileage || '';
            document.getElementById('lastTimingBeltMileage').value = car.lastTimingBeltMileage || '';

            document.getElementById('insuranceEndDate').value = car.insuranceEndDate || ''; // YYYY-MM-DD
            document.getElementById('toEndDate').value = car.toEndDate || ''; // YYYY-MM-DD

            document.getElementById('notes').value = car.notes || '';
            document.querySelector('[name="link1"]').value = car.link1 || '';
            document.querySelector('[name="link2"]').value = car.link2 || '';
            document.querySelector('[name="link3"]').value = car.link3 || '';
            document.querySelector('[name="link4"]').value = car.link4 || '';
        }

        function getCarDetailsFromForm() {
            const formData = new FormData(carDetailsForm);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            // Convert numbers
            data.currentMileage = data.currentMileage ? parseInt(data.currentMileage) : null;
            data.lastOilChangeMileage = data.lastOilChangeMileage ? parseInt(data.lastOilChangeMileage) : null;
            data.lastTimingBeltMileage = data.lastTimingBeltMileage ? parseInt(data.lastTimingBeltMileage) : null;

            return data;
        }

        function saveCarDetails() {
            const carId = currentCarIdInput.value;
            const formData = getCarDetailsFromForm();

            if (!formData.name) {
                Telegram.WebApp.showAlert('Название автомобиля обязательно для заполнения!');
                Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                return;
            }

            if (carId) {
                // Update existing car
                const index = cars.findIndex(car => car.id === carId);
                if (index !== -1) {
                    cars[index] = { ...cars[index], ...formData };
                }
            } else {
                // Add new car
                if (cars.length >= MAX_CARS) {
                    Telegram.WebApp.showAlert(`Вы можете добавить не более ${MAX_CARS} автомобилей.`);
                    Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                    return;
                }
                formData.id = generateUniqueId();
                cars.push(formData);
            }
            saveCars();
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        // --- Event Listeners ---

        // Add New Car Button
        document.getElementById('addCarButton').addEventListener('click', () => {
            resetCarDetailsForm();
            showScreen('carDetailsScreen');
        });

        // Back Button
        document.getElementById('backButton').addEventListener('click', () => {
            saveCarDetails(); // Auto-save when going back
            showScreen('mainScreen');
        });

        // Auto-save on form changes
        carDetailsForm.addEventListener('change', () => {
            // Delay save slightly to avoid multiple saves on rapid input
            // In a real app, you might debounce this
            saveCarDetails();
        });

        carNameInput.addEventListener('input', () => {
            carDetailsHeader.textContent = carNameInput.value || 'Новый Авто';
        });

        // Copy VIN/Plate Number
        document.getElementById('copyVin').addEventListener('click', () => {
            const vin = document.getElementById('vin').value;
            if (vin) {
                navigator.clipboard.writeText(vin).then(() => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    Telegram.WebApp.showAlert('VIN скопирован!');
                }).catch(err => {
                    Telegram.WebApp.showAlert('Ошибка копирования VIN: ' + err.message);
                });
            }
        });

        document.getElementById('copyPlateNumber').addEventListener('click', () => {
            const plateNumber = document.getElementById('plateNumber').value;
            if (plateNumber) {
                navigator.clipboard.writeText(plateNumber).then(() => {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    Telegram.WebApp.showAlert('Госномер скопирован!');
                }).catch(err => {
                    Telegram.WebApp.showAlert('Ошибка копирования госномера: ' + err.message);
                });
            }
        });

        // Update Mileage
        document.getElementById('updateMileage').addEventListener('click', () => {
            // Here you would typically get the current mileage from an external source
            // or just update it manually. For now, it's a placeholder.
            Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            Telegram.WebApp.showAlert('Функция обновления пробега пока не реализована.');
            // You might want to pre-fill with a suggestion or dialog for input
        });

        // Function to edit an existing car
        function editCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (car) {
                fillCarDetailsForm(car);
                showScreen('carDetailsScreen');
            } else {
                Telegram.WebApp.showAlert('Автомобиль не найден.');
            }
        }

        // Initial load of cars when the app starts
        loadCars();

    </script>
</body>
</html>
