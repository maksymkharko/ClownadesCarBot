<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мои авто</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --tg-theme-bg-color: var(--tg-theme-bg-color, #0a0a0c);
            --tg-theme-text-color: var(--tg-theme-text-color, #ffffff);
            --tg-theme-hint-color: var(--tg-theme-hint-color, rgba(255, 255, 255, 0.65));
            --tg-theme-link-color: var(--tg-theme-link-color, #0A84FF);
            --tg-theme-button-color: var(--tg-theme-button-color, #0A84FF);
            --tg-theme-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-theme-secondary-bg-color: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.07));
            --tg-theme-destructive-text-color: var(--tg-theme-destructive-text-color, #FF453A);
            
            --glass-background: rgba(15, 17, 21, 0.65);
            --glass-border: var(--tg-theme-secondary-bg-color);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --modal-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --button-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            min-height: 100vh;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 20px;
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--button-shadow);
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            flex: 1;
        }

        .add-button {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: var(--glass-background);
            color: var(--tg-theme-text-color);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        /* Car List */
        .car-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .car-item {
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .car-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        .car-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        /* Timers */
        .timers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .timer {
            background: var(--glass-background);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        .timer-label {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-bottom: 5px;
        }

        .timer-value {
            font-size: 18px;
            font-weight: 600;
        }

        .timer.warning .timer-value {
            color: var(--tg-theme-destructive-text-color);
            animation: blink 1s infinite;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--glass-background);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .close-button {
            background: none;
            border: none;
            color: var(--tg-theme-text-color);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--tg-theme-hint-color);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: var(--tg-theme-secondary-bg-color);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--tg-theme-text-color);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--tg-theme-button-color);
            outline: none;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button-primary {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .button-danger {
            background: var(--tg-theme-destructive-text-color);
            color: var(--tg-theme-button-text-color);
        }

        .button-secondary {
            background: var(--glass-background);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--glass-border);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            color: var(--tg-theme-text-color);
            font-size: 16px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--glass-border);
            z-index: 100;
        }

        .footer-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .author-link {
            color: var(--tg-theme-hint-color);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .author-link:hover {
            color: var(--tg-theme-text-color);
        }

        .footer-buttons {
            display: flex;
            gap: 10px;
        }

        .footer-button {
            background: none;
            border: none;
            color: var(--tg-theme-hint-color);
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            transition: color 0.3s ease;
        }

        .footer-button:hover {
            color: var(--tg-theme-text-color);
        }

        .footer-button.danger:hover {
            color: var(--tg-theme-destructive-text-color);
        }

        /* Animations */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .app-container {
                padding: 15px;
            }

            .modal {
                padding: 15px;
            }

            .modal-content {
                padding: 20px;
            }

            .timers-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div style="width: 40px"></div>
            <h1 class="header-title">Мои авто</h1>
            <button class="add-button" id="addCarButton">
                <i class="fas fa-plus"></i>
            </button>
        </header>
        <div class="car-list" id="carList"></div>
    </div>

    <!-- Add Car Modal -->
    <div class="modal" id="addCarModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Добавить автомобиль</h2>
                <button class="close-button" onclick="closeModal('addCarModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addCarForm">
                <div class="form-group">
                    <label for="carName">Название машины*</label>
                    <input type="text" id="carName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="mileage">Актуальный пробег (км)*</label>
                    <input type="number" id="mileage" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="vin">VIN*</label>
                    <input type="text" id="vin" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="plate">Номер машины*</label>
                    <input type="text" id="plate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="purchaseDate">Дата покупки*</label>
                    <input type="date" id="purchaseDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="lastOilChange">Пробег на последней замене масла (км)*</label>
                    <input type="number" id="lastOilChange" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="lastTimingBelt">Пробег на последней замене ГРМ (км)*</label>
                    <input type="number" id="lastTimingBelt" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="insuranceEnd">Дата окончания страховки*</label>
                    <input type="date" id="insuranceEnd" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="maintenanceEnd">Дата окончания ТО*</label>
                    <input type="date" id="maintenanceEnd" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="description">Описание</label>
                    <textarea id="description" class="form-control" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="link1">Ссылка 1</label>
                    <input type="url" id="link1" class="form-control">
                </div>
                <div class="form-group">
                    <label for="link2">Ссылка 2</label>
                    <input type="url" id="link2" class="form-control">
                </div>
                <div class="form-group">
                    <label for="link3">Ссылка 3</label>
                    <input type="url" id="link3" class="form-control">
                </div>
                <div class="form-group">
                    <label for="link4">Ссылка 4</label>
                    <input type="url" id="link4" class="form-control">
                </div>
                <div class="button-group">
                    <button type="submit" class="button button-primary">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                    <button type="button" class="button button-secondary" onclick="closeModal('addCarModal')">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Car Modal -->
    <div class="modal" id="viewCarModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Информация об автомобиле</h2>
                <button class="close-button" onclick="closeModal('viewCarModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="carInfo"></div>
            <div class="button-group">
                <button class="button button-primary" onclick="handleEditCar()">
                    <i class="fas fa-edit"></i> Редактировать
                </button>
                <button class="button button-danger" onclick="showDeleteConfirmation()">
                    <i class="fas fa-trash"></i> Удалить
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Подтверждение удаления</h2>
                <button class="close-button" onclick="closeModal('deleteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p>Вы уверены, что хотите удалить этот автомобиль?</p>
            <div class="button-group">
                <button class="button button-danger" onclick="handleDeleteCar()">
                    <i class="fas fa-trash"></i> Удалить
                </button>
                <button class="button button-secondary" onclick="closeModal('deleteModal')">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <a href="https://t.me/clownades" class="author-link" target="_blank">@clownades</a>
            <div class="footer-buttons">
                <button class="footer-button" onclick="viewStorageData()">
                    <i class="fas fa-database"></i>
                </button>
                <button class="footer-button danger" onclick="clearStorage()">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </footer>

    <script>
        // Constants
        const OIL_CHANGE_INTERVAL = 10000; // 10,000 km
        const TIMING_BELT_INTERVAL = 60000; // 60,000 km
        const WARNING_DAYS = 7;

        // State
        let cars = [];
        let currentCarIndex = -1;
        let userId = null;

        // Telegram WebApp
        const tg = window.Telegram.WebApp;

        // Initialize
        async function init() {
            try {
                // Get user ID
                userId = tg.initDataUnsafe?.user?.id;
                if (!userId) {
                    throw new Error('User ID not available');
                }

                // Initialize Telegram WebApp
                tg.expand();
                tg.enableClosingConfirmation();

                // Load cars
                await loadCars();

                // Setup event listeners
                setupEventListeners();

                // Adapt theme
                adaptTheme();
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Ошибка инициализации: ' + error.message, 'error');
            }
        }

        // Load cars from CloudStorage
        async function loadCars() {
            try {
                console.log('Loading cars for user:', userId);
                const storageKey = `cars_${userId}`;
                
                // Получаем все данные из хранилища
                const allData = await tg.CloudStorage.getItems();
                console.log('All storage data:', allData);
                
                // Ищем данные для текущего пользователя
                const userData = allData[storageKey];
                console.log('User data:', userData);
                
                if (userData) {
                    try {
                        // Пробуем распарсить данные
                        const parsedData = typeof userData === 'string' ? JSON.parse(userData) : userData;
                        console.log('Parsed data:', parsedData);
                        
                        if (Array.isArray(parsedData)) {
                            cars = parsedData;
                        } else {
                            console.warn('Data is not an array, initializing empty array');
                            cars = [];
                        }
                    } catch (error) {
                        console.error('Error parsing data:', error);
                        cars = [];
                    }
                } else {
                    console.log('No data found for user');
                    cars = [];
                }
                
                console.log('Loaded cars:', cars);
                renderCars();
            } catch (error) {
                console.error('Loading error:', error);
                showToast('Ошибка загрузки данных', 'error');
                cars = [];
                renderCars();
            }
        }

        // Save cars to CloudStorage
        async function saveCars() {
            try {
                console.log('Saving cars for user:', userId);
                const storageKey = `cars_${userId}`;
                
                // Преобразуем данные в строку
                const dataToSave = JSON.stringify(cars);
                console.log('Data to save:', dataToSave);
                
                // Сохраняем данные
                await tg.CloudStorage.setItem(storageKey, dataToSave);
                
                // Проверяем, что данные сохранились
                const savedData = await tg.CloudStorage.getItem(storageKey);
                console.log('Saved data:', savedData);
                
                if (!savedData) {
                    throw new Error('Data was not saved properly');
                }
                
                renderCars();
            } catch (error) {
                console.error('Saving error:', error);
                showToast('Ошибка сохранения данных', 'error');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Add car button
            document.getElementById('addCarButton').addEventListener('click', () => {
                showModal('addCarModal');
                triggerHapticFeedback('light');
            });

            // Add car form
            document.getElementById('addCarForm').addEventListener('submit', handleAddCar);

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target.id);
                }
            });

            // Update timers every minute
            setInterval(renderCars, 60000);
        }

        // Handle add car
        async function handleAddCar(e) {
            e.preventDefault();
            
            try {
                console.log('Adding new car');
                const newCar = {
                    id: `${userId}_${Date.now()}`,
                    name: document.getElementById('carName').value,
                    mileage: parseInt(document.getElementById('mileage').value),
                    vin: document.getElementById('vin').value.toUpperCase(),
                    plate: document.getElementById('plate').value.toUpperCase(),
                    purchaseDate: document.getElementById('purchaseDate').value,
                    lastOilChangeMileage: parseInt(document.getElementById('lastOilChange').value),
                    lastTimingBeltMileage: parseInt(document.getElementById('lastTimingBelt').value),
                    insuranceEndDate: document.getElementById('insuranceEnd').value,
                    maintenanceEndDate: document.getElementById('maintenanceEnd').value,
                    description: document.getElementById('description').value || '',
                    link1: formatURL(document.getElementById('link1').value),
                    link2: formatURL(document.getElementById('link2').value),
                    link3: formatURL(document.getElementById('link3').value),
                    link4: formatURL(document.getElementById('link4').value)
                };

                console.log('New car object:', newCar);
                cars.push(newCar);
                
                // Сохраняем данные
                await saveCars();
                
                closeModal('addCarModal');
                document.getElementById('addCarForm').reset();
                showToast('Автомобиль добавлен');
                triggerHapticFeedback('success');
            } catch (error) {
                console.error('Add car error:', error);
                showToast('Ошибка при добавлении автомобиля', 'error');
            }
        }

        // Handle edit car
        async function handleEditCar() {
            try {
                const car = cars[currentCarIndex];
                const carInfo = document.getElementById('carInfo');
                
                if (carInfo.classList.contains('editing')) {
                    // Save changes
                    car.name = carInfo.querySelector('[data-field="name"]').value;
                    car.mileage = parseInt(carInfo.querySelector('[data-field="mileage"]').value);
                    car.vin = carInfo.querySelector('[data-field="vin"]').value.toUpperCase();
                    car.plate = carInfo.querySelector('[data-field="plate"]').value.toUpperCase();
                    car.purchaseDate = carInfo.querySelector('[data-field="purchaseDate"]').value;
                    car.lastOilChangeMileage = parseInt(carInfo.querySelector('[data-field="lastOilChangeMileage"]').value);
                    car.lastTimingBeltMileage = parseInt(carInfo.querySelector('[data-field="lastTimingBeltMileage"]').value);
                    car.insuranceEndDate = carInfo.querySelector('[data-field="insuranceEndDate"]').value;
                    car.maintenanceEndDate = carInfo.querySelector('[data-field="maintenanceEndDate"]').value;
                    car.description = carInfo.querySelector('[data-field="description"]').value;
                    car.link1 = formatURL(carInfo.querySelector('[data-field="link1"]').value);
                    car.link2 = formatURL(carInfo.querySelector('[data-field="link2"]').value);
                    car.link3 = formatURL(carInfo.querySelector('[data-field="link3"]').value);
                    car.link4 = formatURL(carInfo.querySelector('[data-field="link4"]').value);

                    await saveCars();
                    showToast('Изменения сохранены');
                    triggerHapticFeedback('success');
                    
                    carInfo.classList.remove('editing');
                    renderCarInfo(car);
                } else {
                    // Enter edit mode
                    carInfo.classList.add('editing');
                    renderCarInfoEditable(car);
                }
            } catch (error) {
                console.error('Edit car error:', error);
                showToast('Ошибка при редактировании автомобиля', 'error');
            }
        }

        // Handle delete car
        async function handleDeleteCar() {
            try {
                cars.splice(currentCarIndex, 1);
                await saveCars();
                
                closeModal('deleteModal');
                closeModal('viewCarModal');
                showToast('Автомобиль удален');
                triggerHapticFeedback('success');
            } catch (error) {
                console.error('Delete car error:', error);
                showToast('Ошибка при удалении автомобиля', 'error');
            }
        }

        // Render cars
        function renderCars() {
            const carList = document.getElementById('carList');
            carList.innerHTML = '';
            
            cars.forEach((car, index) => {
                const carElement = createCarElement(car, index);
                carList.appendChild(carElement);
            });
        }

        // Create car element
        function createCarElement(car, index) {
            const div = document.createElement('div');
            div.className = 'car-item';
            div.innerHTML = `
                <div class="car-name">${car.name}</div>
                <div class="timers-grid">
                    <div class="timer ${isDateWarning(car.insuranceEndDate) ? 'warning' : ''}">
                        <div class="timer-label">Страховка</div>
                        <div class="timer-value">${formatTimeRemaining(car.insuranceEndDate)}</div>
                    </div>
                    <div class="timer ${isDateWarning(car.maintenanceEndDate) ? 'warning' : ''}">
                        <div class="timer-label">ТО</div>
                        <div class="timer-value">${formatTimeRemaining(car.maintenanceEndDate)}</div>
                    </div>
                    <div class="timer">
                        <div class="timer-label">До замены масла</div>
                        <div class="timer-value">${formatMileageRemaining(car.mileage, car.lastOilChangeMileage)} км</div>
                    </div>
                </div>
            `;

            div.addEventListener('click', () => {
                currentCarIndex = index;
                showCarDetails(car);
                triggerHapticFeedback('light');
            });
            
            return div;
        }

        // Show car details
        function showCarDetails(car) {
            const carInfo = document.getElementById('carInfo');
            carInfo.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <label>VIN:</label>
                        <div class="vin-container">
                            <span>${car.vin}</span>
                            <button class="button button-secondary" onclick="copyVIN('${car.vin}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="info-item">
                        <label>Номер:</label>
                        <span>${car.plate}</span>
                    </div>
                    <div class="info-item">
                        <label>Пробег:</label>
                        <span>${car.mileage} км</span>
                    </div>
                    <div class="info-item">
                        <label>Дата покупки:</label>
                        <span>${formatDate(car.purchaseDate)}</span>
                    </div>
                    <div class="info-item">
                        <label>Последняя замена масла:</label>
                        <span>${car.lastOilChangeMileage} км</span>
                    </div>
                    <div class="info-item">
                        <label>Последняя замена ГРМ:</label>
                        <span>${car.lastTimingBeltMileage} км</span>
                    </div>
                    <div class="info-item">
                        <label>Страховка до:</label>
                        <span>${formatDate(car.insuranceEndDate)}</span>
                    </div>
                    <div class="info-item">
                        <label>ТО до:</label>
                        <span>${formatDate(car.maintenanceEndDate)}</span>
                    </div>
                    <div class="info-item full-width">
                        <label>Описание:</label>
                        <div class="description-text">${car.description || 'Нет описания'}</div>
                    </div>
                    ${renderLinks(car)}
                </div>
            `;
            
            showModal('viewCarModal');
        }

        // Render car info editable
        function renderCarInfoEditable(car) {
            const carInfo = document.getElementById('carInfo');
            carInfo.innerHTML = `
                <form id="editCarForm">
                    <div class="form-group">
                        <label>Название:</label>
                        <input type="text" data-field="name" class="form-control" value="${car.name}" required>
                    </div>
                    <div class="form-group">
                        <label>VIN:</label>
                        <input type="text" data-field="vin" class="form-control" value="${car.vin}" required>
                    </div>
                    <div class="form-group">
                        <label>Номер:</label>
                        <input type="text" data-field="plate" class="form-control" value="${car.plate}" required>
                    </div>
                    <div class="form-group">
                        <label>Пробег (км):</label>
                        <input type="number" data-field="mileage" class="form-control" value="${car.mileage}" required>
                    </div>
                    <div class="form-group">
                        <label>Дата покупки:</label>
                        <input type="date" data-field="purchaseDate" class="form-control" value="${car.purchaseDate}" required>
                    </div>
                    <div class="form-group">
                        <label>Пробег на последней замене масла (км):</label>
                        <input type="number" data-field="lastOilChangeMileage" class="form-control" value="${car.lastOilChangeMileage}" required>
                    </div>
                    <div class="form-group">
                        <label>Пробег на последней замене ГРМ (км):</label>
                        <input type="number" data-field="lastTimingBeltMileage" class="form-control" value="${car.lastTimingBeltMileage}" required>
                    </div>
                    <div class="form-group">
                        <label>Страховка до:</label>
                        <input type="date" data-field="insuranceEndDate" class="form-control" value="${car.insuranceEndDate}" required>
                    </div>
                    <div class="form-group">
                        <label>ТО до:</label>
                        <input type="date" data-field="maintenanceEndDate" class="form-control" value="${car.maintenanceEndDate}" required>
                    </div>
                    <div class="form-group">
                        <label>Описание:</label>
                        <textarea data-field="description" class="form-control" rows="4">${car.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Ссылка 1:</label>
                        <input type="url" data-field="link1" class="form-control" value="${car.link1 || ''}">
                    </div>
                    <div class="form-group">
                        <label>Ссылка 2:</label>
                        <input type="url" data-field="link2" class="form-control" value="${car.link2 || ''}">
                    </div>
                    <div class="form-group">
                        <label>Ссылка 3:</label>
                        <input type="url" data-field="link3" class="form-control" value="${car.link3 || ''}">
                    </div>
                    <div class="form-group">
                        <label>Ссылка 4:</label>
                        <input type="url" data-field="link4" class="form-control" value="${car.link4 || ''}">
                    </div>
                </form>
            `;
        }

        // Render links
        function renderLinks(car) {
            return ['link1', 'link2', 'link3', 'link4']
                .map((link, index) => {
                    const url = car[link];
                    return url ? `
                        <div class="info-item">
                            <label>Ссылка ${index + 1}:</label>
                            <a href="${url}" target="_blank">${url}</a>
                        </div>
                    ` : '';
                })
                .join('');
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Show delete confirmation
        function showDeleteConfirmation() {
            showModal('deleteModal');
        }

        // Copy VIN
        function copyVIN(vin) {
            navigator.clipboard.writeText(vin).then(() => {
                showToast('VIN скопирован');
                triggerHapticFeedback('success');
            }).catch(error => {
                console.error('Copy error:', error);
                showToast('Ошибка при копировании VIN', 'error');
            });
        }

        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ru-RU');
        }

        // Format time remaining
        function formatTimeRemaining(dateString) {
            const end = new Date(dateString);
            const now = new Date();
            const diff = end - now;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            return `${days} дн.`;
        }

        // Format mileage remaining
        function formatMileageRemaining(currentMileage, lastChangeMileage) {
            const remaining = OIL_CHANGE_INTERVAL - (currentMileage - lastChangeMileage);
            return remaining > 0 ? remaining : 0;
        }

        // Check if date is warning
        function isDateWarning(dateString) {
            const end = new Date(dateString);
            const now = new Date();
            const diff = end - now;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            return days <= WARNING_DAYS;
        }

        // Format URL
        function formatURL(url) {
            if (!url) return '';
            
            url = url.trim();
            if (!url) return '';
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            
            try {
                new URL(url);
                return url;
            } catch {
                return '';
            }
        }

        // Trigger haptic feedback
        function triggerHapticFeedback(type = 'light') {
            if (tg.isVersionAtLeast('6.1')) {
                const impactStyle = {
                    'light': 'light',
                    'medium': 'medium',
                    'heavy': 'heavy',
                    'success': 'medium',
                    'error': 'heavy'
                }[type] || 'light';
                
                try {
                    tg.HapticFeedback.impactOccurred(impactStyle);
                } catch (error) {
                    console.error('Haptic feedback error:', error);
                }
            }
        }

        // Adapt theme
        function adaptTheme() {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#0a0a0c');
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || 'rgba(255, 255, 255, 0.65)');
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#0A84FF');
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#0A84FF');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || 'rgba(255, 255, 255, 0.07)');
            document.documentElement.style.setProperty('--tg-theme-destructive-text-color', tg.themeParams.destructive_text_color || '#FF453A');

            tg.onEvent('themeChanged', adaptTheme);
        }

        // View storage data
        async function viewStorageData() {
            try {
                const allData = await tg.CloudStorage.getItems();
                console.log('All CloudStorage data:', allData);
                
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Данные в хранилище</h2>
                            <button class="close-button" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: var(--glass-background); padding: 15px; border-radius: 8px; margin: 10px 0;">${JSON.stringify(allData, null, 2)}</pre>
                        <div class="button-group">
                            <button class="button button-danger" onclick="clearAllStorageData()">
                                <i class="fas fa-trash"></i> Очистить все данные
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('View storage error:', error);
                showToast('Ошибка при просмотре данных хранилища', 'error');
            }
        }

        // Clear all storage data
        async function clearAllStorageData() {
            try {
                if (confirm('Вы уверены, что хотите удалить ВСЕ данные приложения? Это действие нельзя отменить.')) {
                    const allData = await tg.CloudStorage.getItems();
                    
                    for (const key in allData) {
                        await tg.CloudStorage.removeItem(key);
                    }
                    
                    cars = [];
                    renderCars();
                    
                    document.querySelector('.modal').remove();
                    showToast('Все данные удалены');
                    triggerHapticFeedback('success');
                }
            } catch (error) {
                console.error('Clear storage error:', error);
                showToast('Ошибка при очистке данных хранилища', 'error');
            }
        }

        // Clear storage
        async function clearStorage() {
            try {
                if (confirm('Вы уверены, что хотите удалить все данные? Это действие нельзя отменить.')) {
                    const storageKey = `cars_${userId}`;
                    
                    // Сначала очищаем локальный массив
                    cars = [];
                    renderCars();
                    
                    // Удаляем данные из CloudStorage
                    await tg.CloudStorage.removeItem(storageKey);
                    
                    // Проверяем, что данные действительно удалены
                    const checkData = await tg.CloudStorage.getItem(storageKey);
                    if (checkData) {
                        // Если данные все еще существуют, пробуем удалить еще раз
                        await tg.CloudStorage.removeItem(storageKey);
                    }
                    
                    // Очищаем все возможные ключи, связанные с этим пользователем
                    const allData = await tg.CloudStorage.getItems();
                    for (const key in allData) {
                        if (key.startsWith(`cars_${userId}`)) {
                            await tg.CloudStorage.removeItem(key);
                        }
                    }
                    
                    showToast('Хранилище очищено');
                    triggerHapticFeedback('success');
                }
            } catch (error) {
                console.error('Clear storage error:', error);
                showToast('Ошибка при очистке хранилища', 'error');
                // Даже при ошибке очищаем локальный массив
                cars = [];
                renderCars();
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await tg.ready();
                await init();
            } catch (error) {
                console.error('Start error:', error);
                showToast('Ошибка запуска приложения: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
