<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои авто</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .add-button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .car-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .car-item {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            margin: 20px auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .button-primary {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .button-danger {
            background: var(--tg-theme-destructive-text-color, #ff3b30);
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Мои авто</h1>
        <button class="add-button" onclick="showModal('addCarModal')">+ Добавить</button>
    </div>

    <div class="car-list" id="carList"></div>

    <!-- Add Car Modal -->
    <div class="modal" id="addCarModal">
        <div class="modal-content">
            <h2>Добавить автомобиль</h2>
            <form id="addCarForm">
                <div class="form-group">
                    <label>Название:</label>
                    <input type="text" id="carName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>VIN:</label>
                    <input type="text" id="vin" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Номер:</label>
                    <input type="text" id="plate" class="form-control" required>
                </div>
                <div class="button-group">
                    <button type="submit" class="button button-primary">Сохранить</button>
                    <button type="button" class="button" onclick="closeModal('addCarModal')">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let cars = [];
        let userId = null;

        // Инициализация
        async function init() {
            userId = tg.initDataUnsafe?.user?.id;
            if (!userId) {
                alert('Ошибка: ID пользователя не найден');
                return;
            }
            await loadCars();
        }

        // Загрузка автомобилей
        async function loadCars() {
            try {
                const storageKey = `cars_${userId}`;
                const data = await tg.CloudStorage.getItem(storageKey);
                cars = data ? JSON.parse(data) : [];
                renderCars();
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                cars = [];
                renderCars();
            }
        }

        // Сохранение автомобилей
        async function saveCars() {
            try {
                const storageKey = `cars_${userId}`;
                await tg.CloudStorage.setItem(storageKey, JSON.stringify(cars));
                renderCars();
            } catch (error) {
                console.error('Ошибка сохранения:', error);
            }
        }

        // Отображение автомобилей
        function renderCars() {
            const carList = document.getElementById('carList');
            carList.innerHTML = cars.map((car, index) => `
                <div class="car-item" onclick="deleteCar(${index})">
                    <div>${car.name}</div>
                    <div>VIN: ${car.vin}</div>
                    <div>Номер: ${car.plate}</div>
                </div>
            `).join('');
        }

        // Добавление автомобиля
        document.getElementById('addCarForm').onsubmit = async (e) => {
            e.preventDefault();
            const newCar = {
                name: document.getElementById('carName').value,
                vin: document.getElementById('vin').value.toUpperCase(),
                plate: document.getElementById('plate').value.toUpperCase()
            };
            cars.push(newCar);
            await saveCars();
            closeModal('addCarModal');
            document.getElementById('addCarForm').reset();
        };

        // Удаление автомобиля
        async function deleteCar(index) {
            if (confirm('Удалить этот автомобиль?')) {
                cars.splice(index, 1);
                await saveCars();
            }
        }

        // Показ модального окна
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Закрытие модального окна
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Запуск приложения
        tg.ready();
        init();
    </script>
</body>
</html>
