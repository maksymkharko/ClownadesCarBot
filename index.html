<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarCare</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #707579);
            --link-color: var(--tg-theme-link-color, #3390ec);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .container {
            padding: 16px;
            padding-bottom: 60px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .add-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--button-color);
            color: var(--button-text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
        }
        
        .car-card {
            background-color: var(--secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: transform 0.2s ease;
        }
        
        .car-card:active {
            transform: scale(0.98);
        }
        
        .car-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .car-mileage {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .indicators {
            display: flex;
            justify-content: space-between;
        }
        
        .indicator {
            font-size: 14px;
            color: var(--hint-color);
        }
        
        .indicator.warning {
            color: #ff6b6b;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            padding: 12px 16px;
            text-align: center;
            font-size: 12px;
            color: var(--hint-color);
            border-top: 1px solid var(--secondary-bg-color);
        }
        
        .footer a {
            color: var(--link-color);
            text-decoration: none;
        }
        
        /* Car detail page styles */
        .back-btn {
            font-size: 20px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: var(--hint-color);
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--secondary-bg-color);
            background-color: var(--secondary-bg-color);
            color: var(--text-color);
            font-size: 16px;
            box-sizing: border-box;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .copy-btn {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            margin-left: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .links-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
        }
        
        .link-item {
            background-color: var(--secondary-bg-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Main Page -->
    <div class="container page active" id="main-page">
        <div class="header">
            <div class="title">Мои автомобили</div>
            <div class="add-btn" id="add-car-btn">+</div>
        </div>
        
        <div id="cars-list">
            <!-- Cars will be added here dynamically -->
        </div>
    </div>
    
    <!-- Add/Edit Car Page -->
    <div class="container page" id="edit-page">
        <div class="header">
            <div class="back-btn" id="back-btn">←</div>
            <div class="title" id="edit-title">Новый автомобиль</div>
            <div style="width: 40px;"></div>
        </div>
        
        <div class="form-group">
            <label>Название</label>
            <input type="text" id="car-name" placeholder="Например: Моя Лада">
        </div>
        
        <div class="form-group">
            <label>VIN</label>
            <div style="display: flex; align-items: center;">
                <input type="text" id="car-vin" placeholder="Введите VIN">
                <button class="copy-btn" id="copy-vin-btn">Копировать</button>
            </div>
        </div>
        
        <div class="form-group">
            <label>Госномер</label>
            <div style="display: flex; align-items: center;">
                <input type="text" id="car-plate" placeholder="Введите номер">
                <button class="copy-btn" id="copy-plate-btn">Копировать</button>
            </div>
        </div>
        
        <div class="form-group">
            <label>Дата покупки</label>
            <input type="date" id="car-purchase-date">
        </div>
        
        <div class="form-group">
            <label>Текущий пробег (км)</label>
            <div style="display: flex; align-items: center;">
                <input type="number" id="car-mileage" placeholder="Текущий пробег">
                <button class="copy-btn" id="update-mileage-btn">Обновить</button>
            </div>
        </div>
        
        <div class="form-group">
            <label>Пробег последней замены масла (км)</label>
            <input type="number" id="car-oil-change" placeholder="Пробег при замене масла">
        </div>
        
        <div class="form-group">
            <label>Пробег последней замены ГРМ (км)</label>
            <input type="number" id="car-timing-belt" placeholder="Пробег при замене ГРМ">
        </div>
        
        <div class="form-group">
            <label>Дата окончания страховки</label>
            <input type="date" id="car-insurance-date">
        </div>
        
        <div class="form-group">
            <label>Дата окончания ТО</label>
            <input type="date" id="car-service-date">
        </div>
        
        <div class="form-group">
            <label>Заметки</label>
            <textarea id="car-notes" placeholder="Дополнительная информация"></textarea>
        </div>
        
        <div class="form-group">
            <label>Ссылки</label>
            <div class="links-container">
                <div class="link-item" id="link1">Страховка</div>
                <div class="link-item" id="link2">Сервисная книжка</div>
                <div class="link-item" id="link3">Документы</div>
                <div class="link-item" id="link4">Другое</div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Разработано <a href="https://t.me/clownades" target="_blank">@clownades</a>
    </div>
    
    <script>
        // Telegram WebApp initialization
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // State management
        let cars = [];
        let currentCarId = null;
        
        // DOM elements
        const mainPage = document.getElementById('main-page');
        const editPage = document.getElementById('edit-page');
        const carsList = document.getElementById('cars-list');
        const addCarBtn = document.getElementById('add-car-btn');
        const backBtn = document.getElementById('back-btn');
        const editTitle = document.getElementById('edit-title');
        
        // Car form elements
        const carNameInput = document.getElementById('car-name');
        const carVinInput = document.getElementById('car-vin');
        const carPlateInput = document.getElementById('car-plate');
        const carPurchaseDateInput = document.getElementById('car-purchase-date');
        const carMileageInput = document.getElementById('car-mileage');
        const carOilChangeInput = document.getElementById('car-oil-change');
        const carTimingBeltInput = document.getElementById('car-timing-belt');
        const carInsuranceDateInput = document.getElementById('car-insurance-date');
        const carServiceDateInput = document.getElementById('car-service-date');
        const carNotesInput = document.getElementById('car-notes');
        
        // Buttons
        const copyVinBtn = document.getElementById('copy-vin-btn');
        const copyPlateBtn = document.getElementById('copy-plate-btn');
        const updateMileageBtn = document.getElementById('update-mileage-btn');
        
        // Initialize the app
        async function initApp() {
            // Load cars from Telegram Cloud Storage
            await loadCars();
            
            // Render cars list
            renderCarsList();
            
            // Set up event listeners
            setupEventListeners();
            
            // Check for upcoming events
            checkUpcomingEvents();
        }
        
        // Load cars from Telegram Cloud Storage
        async function loadCars() {
            try {
                const data = await tg.CloudStorage.getItem('cars');
                if (data) {
                    cars = JSON.parse(data);
                }
            } catch (error) {
                console.error('Error loading cars:', error);
            }
        }
        
        // Save cars to Telegram Cloud Storage
        async function saveCars() {
            try {
                await tg.CloudStorage.setItem('cars', JSON.stringify(cars));
                tg.HapticFeedback.impactOccurred('light');
            } catch (error) {
                console.error('Error saving cars:', error);
                showAlert('Ошибка сохранения', 'Не удалось сохранить данные. Попробуйте снова.');
            }
        }
        
        // Render cars list
        function renderCarsList() {
            carsList.innerHTML = '';
            
            if (cars.length === 0) {
                carsList.innerHTML = '<div style="text-align: center; color: var(--hint-color); padding: 40px 0;">Нет добавленных автомобилей</div>';
                return;
            }
            
            cars.forEach((car, index) => {
                const carCard = document.createElement('div');
                carCard.className = 'car-card fade-in';
                carCard.dataset.id = car.id;
                
                // Calculate indicators
                const oilLeft = calculateOilLeft(car);
                const insuranceDaysLeft = calculateDaysLeft(car.insuranceDate);
                const serviceDaysLeft = calculateDaysLeft(car.serviceDate);
                
                carCard.innerHTML = `
                    <div class="car-name">${car.name || 'Без названия'}</div>
                    <div class="car-mileage">${car.mileage ? car.mileage.toLocaleString() + ' км' : '—'}</div>
                    <div class="indicators">
                        <div class="indicator ${oilLeft < 1000 ? 'warning' : ''}">Масло: ${oilLeft >= 0 ? oilLeft + ' км' : '—'}</div>
                        <div class="indicator ${insuranceDaysLeft < 7 ? 'warning' : ''}">Страховка: ${insuranceDaysLeft >= 0 ? insuranceDaysLeft + ' дн.' : '—'}</div>
                        <div class="indicator ${serviceDaysLeft < 7 ? 'warning' : ''}">ТО: ${serviceDaysLeft >= 0 ? serviceDaysLeft + ' дн.' : '—'}</div>
                    </div>
                `;
                
                // Add click event
                carCard.addEventListener('click', () => openEditCar(car.id));
                
                // Add swipe to delete
                setupSwipeToDelete(carCard, index);
                
                carsList.appendChild(carCard);
            });
        }
        
        // Calculate oil change left
        function calculateOilLeft(car) {
            if (!car.mileage || !car.oilChange) return -1;
            return 10000 - (car.mileage - car.oilChange);
        }
        
        // Calculate days left until date
        function calculateDaysLeft(dateString) {
            if (!dateString) return -1;
            
            const dateParts = dateString.split('-');
            const eventDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            const today = new Date();
            
            // Set both dates to midnight for accurate day difference
            today.setHours(0, 0, 0, 0);
            eventDate.setHours(0, 0, 0, 0);
            
            const diffTime = eventDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }
        
        // Open edit car screen
        function openEditCar(carId) {
            tg.HapticFeedback.impactOccurred('light');
            
            currentCarId = carId;
            const car = cars.find(c => c.id === carId);
            
            if (car) {
                editTitle.textContent = car.name || 'Редактировать';
                
                // Fill form with car data
                carNameInput.value = car.name || '';
                carVinInput.value = car.vin || '';
                carPlateInput.value = car.plate || '';
                carPurchaseDateInput.value = car.purchaseDate || '';
                carMileageInput.value = car.mileage || '';
                carOilChangeInput.value = car.oilChange || '';
                carTimingBeltInput.value = car.timingBelt || '';
                carInsuranceDateInput.value = car.insuranceDate || '';
                carServiceDateInput.value = car.serviceDate || '';
                carNotesInput.value = car.notes || '';
                
                // TODO: Load links
            } else {
                editTitle.textContent = 'Новый автомобиль';
                
                // Clear form for new car
                carNameInput.value = '';
                carVinInput.value = '';
                carPlateInput.value = '';
                carPurchaseDateInput.value = '';
                carMileageInput.value = '';
                carOilChangeInput.value = '';
                carTimingBeltInput.value = '';
                carInsuranceDateInput.value = '';
                carServiceDateInput.value = '';
                carNotesInput.value = '';
            }
            
            // Switch to edit page
            mainPage.classList.remove('active');
            editPage.classList.add('active');
        }
        
        // Save car data
        async function saveCar() {
            const carData = {
                id: currentCarId || Date.now().toString(),
                name: carNameInput.value,
                vin: carVinInput.value,
                plate: carPlateInput.value,
                purchaseDate: carPurchaseDateInput.value,
                mileage: carMileageInput.value ? parseInt(carMileageInput.value) : null,
                oilChange: carOilChangeInput.value ? parseInt(carOilChangeInput.value) : null,
                timingBelt: carTimingBeltInput.value ? parseInt(carTimingBeltInput.value) : null,
                insuranceDate: carInsuranceDateInput.value,
                serviceDate: carServiceDateInput.value,
                notes: carNotesInput.value,
                updatedAt: new Date().toISOString()
            };
            
            // Validate
            if (!carData.name) {
                showAlert('Ошибка', 'Пожалуйста, укажите название автомобиля');
                return;
            }
            
            if (currentCarId) {
                // Update existing car
                const index = cars.findIndex(c => c.id === currentCarId);
                if (index !== -1) {
                    cars[index] = carData;
                }
            } else {
                // Check max cars limit
                if (cars.length >= 10) {
                    showAlert('Лимит', 'Максимум 10 автомобилей на аккаунт');
                    return;
                }
                
                // Add new car
                cars.push(carData);
            }
            
            // Save to storage
            await saveCars();
            
            // Go back to main page
            goBack();
            
            // Re-render cars list
            renderCarsList();
        }
        
        // Delete car
        async function deleteCar(carId) {
            tg.HapticFeedback.impactOccurred('heavy');
            
            const confirm = await showConfirm('Удалить автомобиль', 'Вы уверены, что хотите удалить этот автомобиль? Данные будут потеряны.');
            
            if (confirm) {
                cars = cars.filter(car => car.id !== carId);
                await saveCars();
                renderCarsList();
            }
        }
        
        // Setup swipe to delete
        function setupSwipeToDelete(element, index) {
            let startX, moveX;
            const threshold = 50;
            
            element.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            }, { passive: true });
            
            element.addEventListener('touchmove', (e) => {
                moveX = e.touches[0].clientX;
                const diff = startX - moveX;
                
                if (diff > 0) {
                    element.style.transform = `translateX(-${Math.min(diff, 100)}px)`;
                }
            }, { passive: true });
            
            element.addEventListener('touchend', (e) => {
                const diff = startX - moveX;
                
                if (diff > threshold) {
                    deleteCar(element.dataset.id);
                } else {
                    element.style.transform = '';
                }
            }, { passive: true });
        }
        
        // Go back to main page
        function goBack() {
            tg.HapticFeedback.impactOccurred('light');
            editPage.classList.remove('active');
            mainPage.classList.add('active');
            currentCarId = null;
        }
        
        // Check for upcoming events
        function checkUpcomingEvents() {
            const now = new Date();
            const upcomingEvents = [];
            
            cars.forEach(car => {
                // Check insurance
                if (car.insuranceDate) {
                    const daysLeft = calculateDaysLeft(car.insuranceDate);
                    if (daysLeft >= 0 && daysLeft <= 7) {
                        upcomingEvents.push({
                            car: car.name || 'Без названия',
                            type: 'страховка',
                            days: daysLeft
                        });
                    }
                }
                
                // Check service
                if (car.serviceDate) {
                    const daysLeft = calculateDaysLeft(car.serviceDate);
                    if (daysLeft >= 0 && daysLeft <= 7) {
                        upcomingEvents.push({
                            car: car.name || 'Без названия',
                            type: 'ТО',
                            days: daysLeft
                        });
                    }
                }
                
                // Check oil change
                const oilLeft = calculateOilLeft(car);
                if (oilLeft >= 0 && oilLeft <= 1000) {
                    upcomingEvents.push({
                        car: car.name || 'Без названия',
                        type: 'замена масла',
                        km: oilLeft
                    });
                }
            });
            
            if (upcomingEvents.length > 0) {
                let message = 'Внимание:\n\n';
                
                upcomingEvents.forEach(event => {
                    if (event.km !== undefined) {
                        message += `• ${event.car}: скоро ${event.type} (осталось ${event.km} км)\n`;
                    } else {
                        message += `• ${event.car}: скоро ${event.type} (осталось ${event.days} дн.)\n`;
                    }
                });
                
                showAlert('Напоминание', message);
            }
        }
        
        // Show alert
        function showAlert(title, message) {
            return new Promise((resolve) => {
                tg.showAlert(message, resolve);
            });
        }
        
        // Show confirm dialog
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                tg.showConfirm(message, (confirmed) => {
                    resolve(confirmed);
                });
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Add car button
            addCarBtn.addEventListener('click', () => {
                tg.HapticFeedback.impactOccurred('light');
                openEditCar(null);
            });
            
            // Back button
            backBtn.addEventListener('click', goBack);
            
            // Copy buttons
            copyVinBtn.addEventListener('click', () => {
                if (carVinInput.value) {
                    navigator.clipboard.writeText(carVinInput.value);
                    tg.HapticFeedback.impactOccurred('light');
                    tg.showPopup({
                        title: 'Скопировано',
                        message: 'VIN скопирован в буфер обмена',
                        buttons: [{ type: 'ok' }]
                    });
                }
            });
            
            copyPlateBtn.addEventListener('click', () => {
                if (carPlateInput.value) {
                    navigator.clipboard.writeText(carPlateInput.value);
                    tg.HapticFeedback.impactOccurred('light');
                    tg.showPopup({
                        title: 'Скопировано',
                        message: 'Госномер скопирован в буфер обмена',
                        buttons: [{ type: 'ok' }]
                    });
                }
            });
            
            // Update mileage button
            updateMileageBtn.addEventListener('click', () => {
                tg.HapticFeedback.impactOccurred('light');
                // TODO: Implement mileage update logic
                showAlert('Обновление пробега', 'Функция обновления пробега будет реализована в следующей версии');
            });
            
            // Auto-save on input change
            const inputs = [
                carNameInput, carVinInput, carPlateInput, carPurchaseDateInput,
                carMileageInput, carOilChangeInput, carTimingBeltInput,
                carInsuranceDateInput, carServiceDateInput, carNotesInput
            ];
            
            inputs.forEach(input => {
                input.addEventListener('change', saveCar);
            });
            
            // Link buttons
            document.querySelectorAll('.link-item').forEach(link => {
                link.addEventListener('click', () => {
                    tg.HapticFeedback.impactOccurred('light');
                    showAlert('Ссылки', 'Функция управления ссылками будет реализована в следующей версии');
                });
            });
        }
        
        // Initialize the app when ready
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                showAlert('Ошибка', 'Не удалось загрузить данные пользователя. Пожалуйста, откройте приложение через Telegram.');
            });
        }
    </script>
</body>
</html>
