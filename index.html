<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мои Авто</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script>
    const telegram = window.Telegram.WebApp;
    telegram.ready();
    telegram.expand();

    const cloudStorage = telegram.cloudStorage;
    const userId = telegram.initDataUnsafe.user.id;

    const getToday = () => new Date().toISOString().split('T')[0];
    const formatDate = date => new Date(date).toLocaleDateString('ru-RU');
    const daysLeft = date => Math.ceil((new Date(date) - new Date()) / (1000 * 60 * 60 * 24));
    const kmLeftToOil = (current, last) => 10000 - (current - last);

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
        telegram.HapticFeedback.notificationOccurred("success");
      } catch (e) {
        alert("Не удалось скопировать");
      }
    }

    async function deleteCar(key) {
      if (!confirm("Удалить автомобиль?")) return;
      const keys = JSON.parse(await cloudStorage.getItem('car_keys') || '[]');
      await cloudStorage.removeItem(key);
      const updated = keys.filter(k => k !== key);
      await cloudStorage.setItem('car_keys', JSON.stringify(updated));
      location.reload();
    }

    async function renderCars() {
      const container = document.getElementById('car-list');
      container.innerHTML = '';
      const keys = JSON.parse(await cloudStorage.getItem('car_keys') || '[]');

      for (const key of keys) {
        const car = JSON.parse(await cloudStorage.getItem(key));
        const kmLeft = kmLeftToOil(car.currentMileage, car.lastOilChange);
        const daysToInsurance = daysLeft(car.insuranceDate);
        const daysToInspection = daysLeft(car.techInspectionDate);

        const card = document.createElement('div');
        card.className = "bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-4 relative";
        card.innerHTML = `
          <h2 class="text-xl font-bold">${car.name}</h2>
          <p class="text-2xl mt-1">${car.currentMileage} км</p>
          <div class="flex justify-between text-sm text-gray-600 mt-2">
            <span>Масло: ${kmLeft} км</span>
            <span>Страховка: ${daysToInsurance} дн.</span>
            <span>ТО: ${daysToInspection} дн.</span>
          </div>
          <button onclick="deleteCar('${key}')" class="absolute top-2 right-2 text-red-500">Удалить</button>
        `;
        container.appendChild(card);
      }
    }

    async function addCar() {
      const keys = JSON.parse(await cloudStorage.getItem('car_keys') || '[]');
      if (keys.length >= 10) return alert("Максимум 10 авто на аккаунт");

      const id = `car_${Date.now()}`;
      const newCar = {
        name: "Новый автомобиль",
        vin: "",
        plate: "",
        purchaseDate: getToday(),
        currentMileage: 0,
        lastOilChange: 0,
        lastTimingChange: 0,
        insuranceDate: getToday(),
        techInspectionDate: getToday(),
        note: "",
        links: ["", "", "", ""]
      };
      await cloudStorage.setItem(id, JSON.stringify(newCar));
      keys.push(id);
      await cloudStorage.setItem('car_keys', JSON.stringify(keys));
      location.reload();
    }

    window.onload = renderCars;
  </script>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-900 dark:text-white font-sans">
  <header class="bg-blue-600 text-white p-4 text-center font-bold text-xl relative">
    Мои Авто
    <button onclick="addCar()" class="absolute right-4 top-2 text-2xl">+</button>
  </header>
  <main class="p-4" id="car-list"></main>
  <footer class="fixed bottom-0 left-0 right-0 text-center bg-white dark:bg-gray-900 text-sm p-2 border-t dark:border-gray-700">
    Разработано <a href="https://t.me/clownades" class="text-blue-500">@clownades</a>
  </footer>
</body>
</html>
