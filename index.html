<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мои авто</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --background-color: var(--tg-theme-bg-color, #0a0a0c);
            --glass-background: rgba(15, 17, 21, 0.65);
            --glass-border: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.07));
            --text-primary: var(--tg-theme-text-color, #ffffff);
            --text-secondary: var(--tg-theme-hint-color, rgba(255, 255, 255, 0.65));
            --accent-blue: var(--tg-theme-button-color, #0A84FF);
            --accent-red: var(--tg-theme-destructive-text-color, #FF453A);
            --accent-green: #32D74B;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --modal-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --button-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --input-background: var(--tg-theme-secondary-bg-color, rgba(30, 34, 42, 0.5));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Top Panel */
        .top-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 20px;
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--button-shadow);
        }

        .main-title {
            color: var(--text-primary);
            text-align: center;
            font-size: 24px;
            font-weight: 600;
        }

        .add-car-button {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-car-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .add-car-button:active {
            transform: translateY(1px);
        }

        /* Car List */
        .car-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 60px;
        }

        .car-item {
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .car-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        .car-item:active {
            transform: translateY(1px);
        }

        .car-name {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        /* Timer Display */
        .timer-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding: 15px;
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--button-shadow);
        }

        .timer {
            flex: 1;
            background: linear-gradient(180deg, #000000 0%, #1a1a1a 100%);
            padding: 10px;
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.8), 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid #000;
            position: relative;
        }

        .timer::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px 8px 0 0;
        }

        .timer-label {
            color: #fff;
            font-size: 12px;
            margin-bottom: 5px;
            text-align: center;
        }

        .timer-value {
            font-family: "DS-Digital", monospace;
            color: #FF3B30;
            font-size: 24px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 59, 48, 0.5);
            background: linear-gradient(to bottom, #1a1a1a, #000);
            padding: 5px;
            border-radius: 4px;
            letter-spacing: 2px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.8), 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .timer-value::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px 4px 0 0;
        }

        .timer.warning .timer-value {
            color: var(--accent-red);
            animation: blink 1s infinite;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 30px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--glass-background);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 30px;
            width: calc(100% - 60px);
            max-width: 500px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--modal-shadow);
            position: relative;
            margin: auto;
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }

        /* Стилизация скроллбара для WebKit браузеров */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--glass-background);
            border-radius: 4px;
            border: 1px solid var(--glass-border);
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal h2 {
            color: var(--text-primary);
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--input-background);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.1);
            outline: none;
        }

        /* Info Grid Styles */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .info-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            border-radius: 12px 12px 0 0;
            pointer-events: none;
        }

        .info-item label {
            display: block;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .info-item span {
            display: block;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
        }

        .vin-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .copy-button {
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--button-shadow);
            position: relative;
            overflow: hidden;
        }

        .copy-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 100%);
            border-radius: 6px 6px 0 0;
            pointer-events: none;
        }

        .copy-button:active {
            transform: translateY(1px);
        }

        /* Modal Buttons */
        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--glass-border);
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-buttons button i {
            font-size: 18px;
        }

        .modal-buttons button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-buttons button:hover {
            transform: translateY(-2px);
        }

        .modal-buttons button:hover::before {
            opacity: 0.8;
        }

        .modal-buttons button:active {
            transform: translateY(1px);
        }

        .save-button {
            background: var(--tg-theme-button-color, rgba(10, 132, 255, 0.3)) !important;
            color: var(--tg-theme-button-text-color, #ffffff) !important;
            border: 1px solid var(--tg-theme-button-color, rgba(10, 132, 255, 0.3)) !important;
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.2);
        }

        .edit-button {
            background: var(--tg-theme-button-color, rgba(10, 132, 255, 0.3)) !important;
            color: var(--tg-theme-button-text-color, #ffffff) !important;
            border: 1px solid var(--tg-theme-button-color, rgba(10, 132, 255, 0.3)) !important;
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.2);
        }

        .delete-button {
            background: var(--tg-theme-destructive-text-color, rgba(255, 69, 58, 0.3)) !important;
            color: var(--tg-theme-button-text-color, #ffffff) !important;
            border: 1px solid var(--tg-theme-destructive-text-color, rgba(255, 69, 58, 0.3)) !important;
            box-shadow: 0 4px 12px rgba(255, 69, 58, 0.2);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 16px;
            box-shadow: var(--modal-shadow);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Confirmation Dialog */
        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 1500;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .confirmation-dialog.active {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        .dialog-content {
            background: var(--glass-background);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--modal-shadow);
        }

        .dialog-content p {
            color: var(--text-primary);
            font-size: 18px;
            margin-bottom: 24px;
            text-align: center;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .app-container {
                padding: 15px;
            }
            
            .modal {
                padding: 15px;
            }
            
            .modal-content {
                width: calc(100% - 30px);
                padding: 20px;
                max-height: calc(100vh - 30px);
            }
            
            .timer-container {
                flex-direction: column;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Add custom font for timer display */
        @font-face {
            font-family: 'DS-Digital';
            src: url('https://db.onlinewebfonts.com/t/8e22783d707ad140bffe18b2a3812529.woff2') format('woff2');
        }

        /* URL styles */
        .info-item a {
            color: var(--accent-blue);
            text-decoration: none;
            word-break: break-all;
            transition: color 0.2s ease;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .info-item a:hover {
            color: var(--accent-blue);
            text-decoration: underline;
        }

        .description-text {
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .info-item.full-width {
            grid-column: 1 / -1;
        }

        .edit-description-button,
        .save-description-button {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: var(--button-shadow);
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .edit-description-button::before,
        .save-description-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 100%);
            border-radius: 6px 6px 0 0;
            pointer-events: none;
        }

        .edit-description-button:active,
        .save-description-button:active {
            transform: translateY(1px);
        }

        .description-edit {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: var(--input-background);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            margin-top: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            background-image: linear-gradient(180deg, #f8f8f8 0%, #ffffff 100%);
        }

        .description-edit:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2), inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .url-preview {
            display: none;
            font-size: 12px;
            color: var(--accent-blue);
            margin-top: 4px;
            padding: 4px 8px;
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 4px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--button-shadow);
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        /* Transform input to uppercase for VIN and plate number */
        input[id="vin"],
        input[id="plate"] {
            text-transform: uppercase;
        }

        /* Footer Styles */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: var(--glass-background);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .author-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .author-link:hover {
            color: var(--text-primary);
        }

        .clear-storage-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }

        .clear-storage-button:hover {
            color: var(--accent-red);
        }

        .clear-storage-button i {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="top-panel">
            <div style="width: 40px"></div>
            <h1 class="main-title">Мои авто</h1>
            <button class="add-car-button"><i class="fas fa-plus"></i></button>
        </div>
        <div class="car-list" id="carList"></div>
    </div>

    <div class="modal" id="addCarModal">
        <div class="modal-content">
            <h2>Добавить автомобиль</h2>
            <form id="addCarForm">
                <div class="form-group">
                    <label for="carName">Название машины*</label>
                    <input type="text" id="carName" required>
                </div>
                <div class="form-group">
                    <label for="mileage">Актуальный пробег (км)*</label>
                    <input type="number" id="mileage" required>
                </div>
                <div class="form-group">
                    <label for="vin">VIN*</label>
                    <input type="text" id="vin" required>
                </div>
                <div class="form-group">
                    <label for="plate">Номер машины*</label>
                    <input type="text" id="plate" required>
                </div>
                <div class="form-group">
                    <label for="purchaseDate">Дата покупки*</label>
                    <input type="date" id="purchaseDate" required>
                </div>
                <div class="form-group">
                    <label for="lastOilChange">Пробег на последней замене масла (км)*</label>
                    <input type="number" id="lastOilChange" required>
                </div>
                <div class="form-group">
                    <label for="lastTimingBelt">Пробег на последней замене ГРМ (км)*</label>
                    <input type="number" id="lastTimingBelt" required>
                </div>
                <div class="form-group">
                    <label for="insuranceEnd">Дата окончания страховки*</label>
                    <input type="date" id="insuranceEnd" required>
                </div>
                <div class="form-group">
                    <label for="maintenanceEnd">Дата окончания ТО*</label>
                    <input type="date" id="maintenanceEnd" required>
                </div>
                <div class="form-group">
                    <label for="description">Описание</label>
                    <textarea id="description" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="link1">Ссылка 1</label>
                    <input type="url" id="link1">
                </div>
                <div class="form-group">
                    <label for="link2">Ссылка 2</label>
                    <input type="url" id="link2">
                </div>
                <div class="form-group">
                    <label for="link3">Ссылка 3</label>
                    <input type="url" id="link3">
                </div>
                <div class="form-group">
                    <label for="link4">Ссылка 4</label>
                    <input type="url" id="link4">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="save-button">Сохранить</button>
                    <button type="button" class="cancel-button">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="viewCarModal">
        <div class="modal-content">
            <div class="car-info"></div>
            <div class="modal-buttons">
                <button class="edit-button"><i class="fas fa-edit"></i></button>
                <button class="delete-button"><i class="fas fa-trash"></i></button>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>

    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="dialog-content">
            <p>Вы уверены, что хотите удалить этот автомобиль?</p>
            <div class="modal-buttons">
                <button class="confirm-button delete-button">Удалить</button>
                <button class="cancel-button">Отмена</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="footer">
        <div class="footer-content">
            <a href="https://t.me/clownades" class="author-link" target="_blank">@clownades</a>
            <button class="clear-storage-button" onclick="clearStorage()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>

    <script>
        // Load Font Awesome for icons
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
        document.head.appendChild(link);

        // Constants
        const STORAGE_KEY = 'clownadescarskey';
        const OIL_CHANGE_INTERVAL = 10000; // 10,000 km
        const TIMING_BELT_INTERVAL = 60000; // 60,000 km
        const WARNING_DAYS = 7;

        // DOM Elements
        const carList = document.getElementById('carList');
        const addCarModal = document.getElementById('addCarModal');
        const viewCarModal = document.getElementById('viewCarModal');
        const confirmationDialog = document.getElementById('confirmationDialog');
        const toast = document.getElementById('toast');
        const addCarForm = document.getElementById('addCarForm');

        // State
        let cars = [];
        let currentCarIndex = -1;
        let editingCarId = null;
        let updatingMileageCarId = null;
        let userId = null;

        // Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // Haptic feedback
        function triggerHapticFeedback(type = 'light') {
            if (tg.isVersionAtLeast('6.1')) {
                // Map our custom types to Telegram's valid impact styles
                const impactStyle = {
                    'light': 'light',
                    'medium': 'medium',
                    'heavy': 'heavy',
                    'success': 'medium',
                    'error': 'heavy'
                }[type] || 'light';
                
                try {
                    tg.HapticFeedback.impactOccurred(impactStyle);
                } catch (error) {
                    console.log('Haptic feedback error:', error);
                }
            }
        }
        
        // Initialize
        async function init() {
            try {
                console.log('=== Initializing app ===');
                
                // Get user ID
                userId = tg.initDataUnsafe?.user?.id;
                if (!userId) {
                    throw new Error('User ID not available');
                }
                console.log('User ID:', userId);
                
                // Initialize Telegram WebApp
                tg.expand();
                tg.enableClosingConfirmation();
                
                // Initialize CloudStorage
                if (!tg.CloudStorage) {
                    throw new Error('CloudStorage is not available');
                }
                
                setupEventListeners();
                await loadCars();
            } catch (error) {
                console.error('Error during initialization:', error);
                alert('Ошибка инициализации приложения: ' + error.message);
            }
        }

        // Load cars from Telegram Cloud Storage
        async function loadCars() {
            try {
                const storageKey = `cars_${userId}`;
                const data = await tg.CloudStorage.getItem(storageKey);
                
                if (data) {
                    try {
                        const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                        cars = Array.isArray(parsedData) ? parsedData : [];
                    } catch (error) {
                        console.error('Error parsing cars data:', error);
                        cars = [];
                    }
                } else {
                    cars = [];
                }
                
                renderCars();
            } catch (error) {
                console.error('Error loading cars:', error);
                cars = [];
                renderCars();
            }
        }

        async function saveCars() {
            try {
                const storageKey = `cars_${userId}`;
                await tg.CloudStorage.setItem(storageKey, JSON.stringify(cars));
                renderCars();
            } catch (error) {
                console.error('Error saving cars:', error);
                alert('Ошибка сохранения данных');
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, starting app...');
            try {
                await tg.ready();
                console.log('Telegram WebApp ready event fired');
                await init();
            } catch (error) {
                console.error('Error starting app:', error);
                alert('Ошибка запуска приложения: ' + error.message);
            }
        });

        // Adapt theme to Telegram
        function adaptTheme() {
            document.documentElement.style.setProperty('--background-color', tg.themeParams.bg_color || '#0a0a0c');
            document.documentElement.style.setProperty('--glass-border', tg.themeParams.secondary_bg_color || 'rgba(255, 255, 255, 0.07)');
            document.documentElement.style.setProperty('--text-primary', tg.themeParams.text_color || '#ffffff');
            document.documentElement.style.setProperty('--text-secondary', tg.themeParams.hint_color || 'rgba(255, 255, 255, 0.65)');
            document.documentElement.style.setProperty('--accent-blue', tg.themeParams.button_color || '#0A84FF');
            document.documentElement.style.setProperty('--accent-red', tg.themeParams.destructive_text_color || '#FF453A');
            document.documentElement.style.setProperty('--input-background', tg.themeParams.secondary_bg_color || 'rgba(30, 34, 42, 0.5)');

            tg.onEvent('themeChanged', () => {
                document.documentElement.style.setProperty('--background-color', tg.themeParams.bg_color || '#0a0a0c');
                document.documentElement.style.setProperty('--glass-border', tg.themeParams.secondary_bg_color || 'rgba(255, 255, 255, 0.07)');
                document.documentElement.style.setProperty('--text-primary', tg.themeParams.text_color || '#ffffff');
                document.documentElement.style.setProperty('--text-secondary', tg.themeParams.hint_color || 'rgba(255, 255, 255, 0.65)');
                document.documentElement.style.setProperty('--accent-blue', tg.themeParams.button_color || '#0A84FF');
                document.documentElement.style.setProperty('--accent-red', tg.themeParams.destructive_text_color || '#FF453A');
                document.documentElement.style.setProperty('--input-background', tg.themeParams.secondary_bg_color || 'rgba(30, 34, 42, 0.5)');
            });
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Add car button
            const addCarButton = document.querySelector('.add-car-button');
            if (addCarButton) {
                addCarButton.addEventListener('click', () => {
                    addCarModal.style.display = 'block';
                    triggerHapticFeedback('light');
                });
            }

            // Add car form
            if (addCarForm) {
                addCarForm.addEventListener('submit', handleAddCar);
            }

            const cancelButton = addCarModal.querySelector('.cancel-button');
            if (cancelButton) {
                cancelButton.addEventListener('click', () => {
                    addCarModal.style.display = 'none';
                    addCarForm.reset();
                    triggerHapticFeedback('light');
                });
            }

            // View car modal buttons
            const editButton = viewCarModal.querySelector('.edit-button');
            if (editButton) {
                editButton.addEventListener('click', () => {
                    handleEditCar();
                    triggerHapticFeedback('medium');
                });
            }

            const deleteButton = viewCarModal.querySelector('.delete-button');
            if (deleteButton) {
                deleteButton.addEventListener('click', () => {
                    showDeleteConfirmation();
                    triggerHapticFeedback('medium');
                });
            }

            const closeButton = viewCarModal.querySelector('.close-button');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    viewCarModal.style.display = 'none';
                    triggerHapticFeedback('light');
                });
            }

            // Confirmation dialog
            const confirmButton = confirmationDialog.querySelector('.confirm-button');
            if (confirmButton) {
                confirmButton.addEventListener('click', async () => {
                    await handleDeleteCar();
                    triggerHapticFeedback('heavy');
                });
            }

            const cancelConfirmButton = confirmationDialog.querySelector('.cancel-button');
            if (cancelConfirmButton) {
                cancelConfirmButton.addEventListener('click', () => {
                    confirmationDialog.style.display = 'none';
                    triggerHapticFeedback('light');
                });
            }

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === addCarModal) {
                    addCarModal.style.display = 'none';
                    triggerHapticFeedback('light');
                }
                if (e.target === viewCarModal) {
                    viewCarModal.style.display = 'none';
                    triggerHapticFeedback('light');
                }
            });
        }

        // Car Management Functions
        async function handleAddCar(e) {
            e.preventDefault();
            
            try {
                const newCar = {
                    id: userId + '_' + Date.now(),
                    name: document.getElementById('carName').value,
                    mileage: parseInt(document.getElementById('mileage').value),
                    vin: document.getElementById('vin').value.toUpperCase(),
                    plate: document.getElementById('plate').value.toUpperCase(),
                    purchaseDate: document.getElementById('purchaseDate').value,
                    lastOilChangeMileage: parseInt(document.getElementById('lastOilChange').value),
                    lastTimingBeltMileage: parseInt(document.getElementById('lastTimingBelt').value),
                    insuranceEndDate: document.getElementById('insuranceEnd').value,
                    maintenanceEndDate: document.getElementById('maintenanceEnd').value,
                    description: document.getElementById('description').value || '',
                    link1: formatURL(document.getElementById('link1').value),
                    link2: formatURL(document.getElementById('link2').value),
                    link3: formatURL(document.getElementById('link3').value),
                    link4: formatURL(document.getElementById('link4').value)
                };

                cars.push(newCar);
                await saveCars();
                
                addCarModal.style.display = 'none';
                addCarForm.reset();
                showToast('Автомобиль добавлен');
                triggerHapticFeedback('success');
            } catch (error) {
                console.error('Error adding car:', error);
                alert('Ошибка при добавлении автомобиля');
            }
        }

        async function handleEditCar() {
            const carInfo = viewCarModal.querySelector('.car-info');
            const car = cars[currentCarIndex];

            if (carInfo.classList.contains('editing')) {
                // Save changes
                car.name = carInfo.querySelector('[data-field="name"]').value;
                car.mileage = parseInt(carInfo.querySelector('[data-field="mileage"]').value);
                car.vin = carInfo.querySelector('[data-field="vin"]').value.toUpperCase();
                car.plate = carInfo.querySelector('[data-field="plate"]').value.toUpperCase();
                car.purchaseDate = carInfo.querySelector('[data-field="purchaseDate"]').value;
                car.lastOilChangeMileage = parseInt(carInfo.querySelector('[data-field="lastOilChangeMileage"]').value);
                car.lastTimingBeltMileage = parseInt(carInfo.querySelector('[data-field="lastTimingBeltMileage"]').value);
                car.insuranceEndDate = carInfo.querySelector('[data-field="insuranceEndDate"]').value;
                car.maintenanceEndDate = carInfo.querySelector('[data-field="maintenanceEndDate"]').value;
                car.description = carInfo.querySelector('[data-field="description"]').value;
                car.link1 = formatURL(carInfo.querySelector('[data-field="link1"]').value);
                car.link2 = formatURL(carInfo.querySelector('[data-field="link2"]').value);
                car.link3 = formatURL(carInfo.querySelector('[data-field="link3"]').value);
                car.link4 = formatURL(carInfo.querySelector('[data-field="link4"]').value);

                await saveCars();
                showToast('Изменения сохранены');
                triggerHapticFeedback('success');
                
                carInfo.classList.remove('editing');
                viewCarModal.querySelector('.edit-button i').className = 'fas fa-edit';
                renderCarInfo(car);
            } else {
                // Enter edit mode
                carInfo.classList.add('editing');
                viewCarModal.querySelector('.edit-button i').className = 'fas fa-save';
                renderCarInfoEditable(car);
            }
        }

        async function handleDeleteCar() {
            try {
                cars.splice(currentCarIndex, 1);
                await saveCars();
                
                confirmationDialog.style.display = 'none';
                viewCarModal.style.display = 'none';
                showToast('Автомобиль удален');
                triggerHapticFeedback('success');
            } catch (error) {
                console.error('Error deleting car:', error);
                alert('Ошибка при удалении автомобиля');
            }
        }

        // UI Functions
        function renderCars() {
            carList.innerHTML = '';
            cars.forEach((car, index) => {
                const carElement = createCarElement(car, index);
                carList.appendChild(carElement);
            });
        }

        function createCarElement(car, index) {
            const div = document.createElement('div');
            div.className = 'car-item';
            div.innerHTML = `
                <div class="car-name">${car.name}</div>
                <div class="timer-container">
                    <div class="timer ${isDateWarning(car.insuranceEndDate) ? 'warning' : ''}">
                        <div class="timer-label">Страховка</div>
                        <div class="timer-value">${formatTimeRemaining(car.insuranceEndDate)}</div>
                    </div>
                    <div class="timer ${isDateWarning(car.maintenanceEndDate) ? 'warning' : ''}">
                        <div class="timer-label">ТО</div>
                        <div class="timer-value">${formatTimeRemaining(car.maintenanceEndDate)}</div>
                    </div>
                    <div class="timer">
                        <div class="timer-label">До замены масла</div>
                        <div class="timer-value">${formatMileageRemaining(car.mileage, car.lastOilChangeMileage)} км</div>
                    </div>
                </div>
            `;

            div.addEventListener('click', () => {
                showCarDetails(index);
                triggerHapticFeedback('light');
            });
            return div;
        }

        function renderCarInfo(car) {
            const carInfo = viewCarModal.querySelector('.car-info');
            carInfo.innerHTML = `
                <h3>${car.name}</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>VIN:</label>
                        <div class="vin-container">
                            <span>${car.vin}</span>
                            <button class="copy-button" onclick="copyVIN('${car.vin}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="info-item">
                        <label>Номер:</label>
                        <span>${car.plate}</span>
                    </div>
                    <div class="info-item">
                        <label>Пробег:</label>
                        <span>${car.mileage} км</span>
                    </div>
                    <div class="info-item">
                        <label>Дата покупки:</label>
                        <span>${formatDate(car.purchaseDate)}</span>
                    </div>
                    <div class="info-item">
                        <label>Последняя замена масла:</label>
                        <span>${car.lastOilChangeMileage} км</span>
                    </div>
                    <div class="info-item">
                        <label>Последняя замена ГРМ:</label>
                        <span>${car.lastTimingBeltMileage} км</span>
                    </div>
                    <div class="info-item">
                        <label>Страховка до:</label>
                        <span>${formatDate(car.insuranceEndDate)}</span>
                    </div>
                    <div class="info-item">
                        <label>ТО до:</label>
                        <span>${formatDate(car.maintenanceEndDate)}</span>
                    </div>
                    <div class="info-item full-width">
                        <label>Описание:</label>
                        <div class="description-text">${car.description || 'Нет описания'}</div>
                        <button class="edit-description-button" onclick="editDescription(${currentCarIndex})">
                            <i class="fas fa-edit"></i> Редактировать описание
                        </button>
                    </div>
                    ${renderLinks(car)}
                </div>
            `;
        }

        function renderCarInfoEditable(car) {
            const carInfo = viewCarModal.querySelector('.car-info');
            carInfo.innerHTML = `
                <div class="form-group">
                    <label>Название:</label>
                    <input type="text" data-field="name" value="${car.name}" required>
                </div>
                <div class="form-group">
                    <label>VIN:</label>
                    <input type="text" data-field="vin" value="${car.vin}" required>
                </div>
                <div class="form-group">
                    <label>Номер:</label>
                    <input type="text" data-field="plate" value="${car.plate}" required>
                </div>
                <div class="form-group">
                    <label>Пробег (км):</label>
                    <input type="number" data-field="mileage" value="${car.mileage}" required>
                </div>
                <div class="form-group">
                    <label>Дата покупки:</label>
                    <input type="date" data-field="purchaseDate" value="${car.purchaseDate}" required>
                </div>
                <div class="form-group">
                    <label>Пробег на последней замене масла (км):</label>
                    <input type="number" data-field="lastOilChangeMileage" value="${car.lastOilChangeMileage}" required>
                </div>
                <div class="form-group">
                    <label>Пробег на последней замене ГРМ (км):</label>
                    <input type="number" data-field="lastTimingBeltMileage" value="${car.lastTimingBeltMileage}" required>
                </div>
                <div class="form-group">
                    <label>Страховка до:</label>
                    <input type="date" data-field="insuranceEndDate" value="${car.insuranceEndDate}" required>
                </div>
                <div class="form-group">
                    <label>ТО до:</label>
                    <input type="date" data-field="maintenanceEndDate" value="${car.maintenanceEndDate}" required>
                </div>
                <div class="form-group">
                    <label>Описание:</label>
                    <textarea data-field="description" rows="4">${car.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Ссылка 1:</label>
                    <input type="url" data-field="link1" value="${car.link1 || ''}">
                </div>
                <div class="form-group">
                    <label>Ссылка 2:</label>
                    <input type="url" data-field="link2" value="${car.link2 || ''}">
                </div>
                <div class="form-group">
                    <label>Ссылка 3:</label>
                    <input type="url" data-field="link3" value="${car.link3 || ''}">
                </div>
                <div class="form-group">
                    <label>Ссылка 4:</label>
                    <input type="url" data-field="link4" value="${car.link4 || ''}">
                </div>
            `;
        }

        function renderLinks(car) {
            return ['link1', 'link2', 'link3', 'link4']
                .map((link, index) => {
                    const url = car[link];
                    return url ? `
                        <div class="info-item">
                            <label>Ссылка ${index + 1}:</label>
                            <a href="${url}" target="_blank">${url}</a>
                        </div>
                    ` : `
                        <div class="info-item">
                            <label>Ссылка ${index + 1}:</label>
                            <span class="no-link">Нет ссылки</span>
                        </div>
                    `;
                })
                .join('');
        }

        // Utility Functions
        function showCarDetails(index) {
            currentCarIndex = index;
            const car = cars[index];
            renderCarInfo(car);
            viewCarModal.style.display = 'block';
        }

        function showDeleteConfirmation() {
            confirmationDialog.style.display = 'block';
        }

        function copyVIN(vin) {
            navigator.clipboard.writeText(vin).then(() => {
                showToast('VIN скопирован');
                triggerHapticFeedback('success');
            }).catch(err => {
                console.error('Failed to copy VIN:', err);
                showToast('Ошибка при копировании VIN');
                triggerHapticFeedback('error');
            });
        }

        function showToast(message) {
            toast.textContent = message;
            toast.style.display = 'block';
            toast.classList.add('show');
            setTimeout(() => {
                toast.style.display = 'none';
                toast.classList.remove('show');
            }, 3000);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ru-RU');
        }

        function formatTimeRemaining(dateString) {
            const end = new Date(dateString);
            const now = new Date();
            const diff = end - now;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            return `${days} дн.`;
        }

        function formatMileageRemaining(currentMileage, lastChangeMileage) {
            const remaining = OIL_CHANGE_INTERVAL - (currentMileage - lastChangeMileage);
            return remaining > 0 ? remaining : 0;
        }

        function isDateWarning(dateString) {
            const end = new Date(dateString);
            const now = new Date();
            const diff = end - now;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            return days <= WARNING_DAYS;
        }

        function editDescription(index) {
            const car = cars[index];
            const description = car.description || '';
            
            const textarea = document.createElement('textarea');
            textarea.value = description;
            textarea.rows = 4;
            textarea.className = 'description-edit';
            
            const descriptionDiv = viewCarModal.querySelector('.description-text');
            const editButton = viewCarModal.querySelector('.edit-description-button');
            
            descriptionDiv.replaceWith(textarea);
            
            const saveButton = document.createElement('button');
            saveButton.innerHTML = '<i class="fas fa-save"></i> Сохранить';
            saveButton.className = 'save-description-button';
            
            saveButton.addEventListener('click', async () => {
                car.description = textarea.value;
                await saveCars();
                renderCarInfo(car);
                showToast('Описание сохранено');
                triggerHapticFeedback('success');
            });
            
            editButton.replaceWith(saveButton);
            triggerHapticFeedback('light');
        }

        function formatURL(url) {
            if (!url) return '';
            
            url = url.trim();
            if (!url) return '';
            
            url = url.replace(/^(https?:\/\/)/, '');
            
            if (!url) return '';
            
            const fullUrl = `https://${url}`;
            try {
                new URL(fullUrl);
                return fullUrl;
            } catch {
                return '';
            }
        }

        // Add input event listeners for VIN, plate number, and URL fields
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('vin').addEventListener('input', function(e) {
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.toUpperCase();
                this.setSelectionRange(start, end);
            });

            document.getElementById('plate').addEventListener('input', function(e) {
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.toUpperCase();
                this.setSelectionRange(start, end);
            });

            ['link1', 'link2', 'link3', 'link4'].forEach(id => {
                const input = document.getElementById(id);
                const previewId = `${id}Preview`;
                
                let preview = document.getElementById(previewId);
                if (!preview) {
                    preview = document.createElement('div');
                    preview.id = previewId;
                    preview.className = 'url-preview';
                    input.parentNode.insertBefore(preview, input.nextSibling);
                }
                
                input.addEventListener('input', function() {
                    const formattedUrl = formatURL(this.value);
                    if (formattedUrl) {
                        preview.textContent = `Будет сохранено как: ${formattedUrl}`;
                        preview.style.display = 'block';
                    } else {
                        preview.style.display = 'none';
                    }
                });
            });

            // Update timers every minute
            setInterval(() => {
                renderCars();
            }, 60000);
        });

        async function updateMileage(carId, newMileage) {
            try {
                const car = cars.find(c => c.id === carId);
                if (car) {
                    car.mileage = parseInt(newMileage);
                    car.lastOilChange = car.lastOilChange || newMileage;
                    car.lastTimingBeltChange = car.lastTimingBeltChange || newMileage;
                    await saveCars();
                    showToast('Пробег обновлен');
                    triggerHapticFeedback('success');
                }
            } catch (error) {
                console.error('Error updating mileage:', error);
                alert('Ошибка обновления пробега');
            }
        }

        async function deleteCar(carId) {
            try {
                console.log('Deleting car with ID:', carId);
                const index = cars.findIndex(c => c.id === carId);
                if (index !== -1) {
                    cars.splice(index, 1);
                    await saveCars();
                    showToast('Автомобиль удален');
                    triggerHapticFeedback('success');
                }
            } catch (error) {
                console.error('Error deleting car:', error);
                alert('Ошибка удаления автомобиля');
            }
        }

        async function clearStorage() {
            try {
                if (confirm('Вы уверены, что хотите удалить все данные? Это действие нельзя отменить.')) {
                    const storageKey = `cars_${userId}`;
                    await tg.CloudStorage.removeItem(storageKey);
                    cars = [];
                    renderCars();
                    showToast('Хранилище очищено');
                    triggerHapticFeedback('success');
                }
            } catch (error) {
                console.error('Error clearing storage:', error);
                alert('Ошибка при очистке хранилища');
            }
        }
    </script>
</body>
</html>
